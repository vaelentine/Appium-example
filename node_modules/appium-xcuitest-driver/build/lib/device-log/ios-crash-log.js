"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.IOSCrashLog = void 0;

require("source-map-support/register");

var _appiumSupport = require("appium-support");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _logger = _interopRequireDefault(require("../logger"));

var _appiumIosDevice = require("appium-ios-device");

var _path = _interopRequireDefault(require("path"));

var _lodash = _interopRequireDefault(require("lodash"));

var _pyIosDeviceClient = _interopRequireDefault(require("../py-ios-device-client"));

const REAL_DEVICE_MAGIC = '3620bbb0-fb9f-4b62-a668-896f2edc4d88';
const MAGIC_SEP = '/';

class IOSCrashLog {
  constructor(opts = {}) {
    this.udid = opts.udid;
    this.pyideviceClient = this.udid ? new _pyIosDeviceClient.default(this.udid) : null;
    const logDir = opts.udid ? _path.default.resolve(process.env.HOME, 'Library', 'Logs', 'CrashReporter', 'MobileDevice') : _path.default.resolve(process.env.HOME, 'Library', 'Logs', 'DiagnosticReports');
    this.logDir = logDir || _path.default.resolve(process.env.HOME || '/', 'Library', 'Logs', 'DiagnosticReports');
    this.prevLogs = [];
    this.logsSinceLastRequest = [];
    this.phoneName = null;
    this.sim = opts.sim;
  }

  async _gatherFromRealDevice() {
    if (await this.pyideviceClient.assertExists(false)) {
      return (await this.pyideviceClient.listCrashes()).map(x => `${REAL_DEVICE_MAGIC}${MAGIC_SEP}${x}`);
    }

    let crashLogsRoot = this.logDir;

    if (this.udid) {
      this.phoneName = this.phoneName || (await _appiumIosDevice.utilities.getDeviceName(this.udid));
      crashLogsRoot = _path.default.resolve(crashLogsRoot, this.phoneName);
    }

    if (!(await _appiumSupport.fs.exists(crashLogsRoot))) {
      _logger.default.debug(`Crash reports root '${crashLogsRoot}' does not exist. Got nothing to gather.`);

      return [];
    }

    const foundFiles = await _appiumSupport.fs.glob(`${crashLogsRoot}/**/*.crash`, {
      strict: false
    });
    return foundFiles;
  }

  async _gatherFromSimulator() {
    if (!(await _appiumSupport.fs.exists(this.logDir))) {
      _logger.default.debug(`Crash reports root '${this.logDir}' does not exist. Got nothing to gather.`);

      return [];
    }

    const foundFiles = await _appiumSupport.fs.glob(`${this.logDir}/**/*.crash`, {
      strict: false
    });
    return await _bluebird.default.filter(foundFiles, async x => {
      try {
        const content = await _appiumSupport.fs.readFile(x, 'utf8');
        return content.toUpperCase().includes(this.sim.udid.toUpperCase());
      } catch (err) {
        return false;
      }
    });
  }

  async getCrashes() {
    return this.udid ? await this._gatherFromRealDevice() : await this._gatherFromSimulator();
  }

  async startCapture() {
    this.prevLogs = await this.getCrashes();
  }

  async stopCapture() {}

  async getLogs() {
    let crashFiles = await this.getCrashes();

    let diff = _lodash.default.difference(crashFiles, this.prevLogs, this.logsSinceLastRequest);

    this.logsSinceLastRequest = _lodash.default.union(this.logsSinceLastRequest, diff);
    return await this.filesToJSON(diff);
  }

  async getAllLogs() {
    let crashFiles = await this.getCrashes();

    let logFiles = _lodash.default.difference(crashFiles, this.prevLogs);

    return await this.filesToJSON(logFiles);
  }

  async filesToJSON(paths) {
    const tmpRoot = await _appiumSupport.tempDir.openDir();

    try {
      return (await _bluebird.default.map(paths, async fullPath => {
        if (_lodash.default.includes(fullPath, REAL_DEVICE_MAGIC)) {
          const fileName = _lodash.default.last(fullPath.split(MAGIC_SEP));

          try {
            await this.pyideviceClient.exportCrash(fileName, tmpRoot);
          } catch (e) {
            _logger.default.warn(`Cannot export the crash report '${fileName}'. Skipping it. ` + `Original error: ${e.message}`);

            return;
          }

          fullPath = _path.default.join(tmpRoot, fileName);
        }

        const stat = await _appiumSupport.fs.stat(fullPath);
        return {
          timestamp: stat.ctime.getTime(),
          level: 'ALL',
          message: await _appiumSupport.fs.readFile(fullPath, 'utf8')
        };
      })).filter(Boolean);
    } finally {
      await _appiumSupport.fs.rimraf(tmpRoot);
    }
  }

}

exports.IOSCrashLog = IOSCrashLog;
var _default = IOSCrashLog;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9kZXZpY2UtbG9nL2lvcy1jcmFzaC1sb2cuanMiXSwibmFtZXMiOlsiUkVBTF9ERVZJQ0VfTUFHSUMiLCJNQUdJQ19TRVAiLCJJT1NDcmFzaExvZyIsImNvbnN0cnVjdG9yIiwib3B0cyIsInVkaWQiLCJweWlkZXZpY2VDbGllbnQiLCJQeWlkZXZpY2UiLCJsb2dEaXIiLCJwYXRoIiwicmVzb2x2ZSIsInByb2Nlc3MiLCJlbnYiLCJIT01FIiwicHJldkxvZ3MiLCJsb2dzU2luY2VMYXN0UmVxdWVzdCIsInBob25lTmFtZSIsInNpbSIsIl9nYXRoZXJGcm9tUmVhbERldmljZSIsImFzc2VydEV4aXN0cyIsImxpc3RDcmFzaGVzIiwibWFwIiwieCIsImNyYXNoTG9nc1Jvb3QiLCJ1dGlsaXRpZXMiLCJnZXREZXZpY2VOYW1lIiwiZnMiLCJleGlzdHMiLCJsb2ciLCJkZWJ1ZyIsImZvdW5kRmlsZXMiLCJnbG9iIiwic3RyaWN0IiwiX2dhdGhlckZyb21TaW11bGF0b3IiLCJCIiwiZmlsdGVyIiwiY29udGVudCIsInJlYWRGaWxlIiwidG9VcHBlckNhc2UiLCJpbmNsdWRlcyIsImVyciIsImdldENyYXNoZXMiLCJzdGFydENhcHR1cmUiLCJzdG9wQ2FwdHVyZSIsImdldExvZ3MiLCJjcmFzaEZpbGVzIiwiZGlmZiIsIl8iLCJkaWZmZXJlbmNlIiwidW5pb24iLCJmaWxlc1RvSlNPTiIsImdldEFsbExvZ3MiLCJsb2dGaWxlcyIsInBhdGhzIiwidG1wUm9vdCIsInRlbXBEaXIiLCJvcGVuRGlyIiwiZnVsbFBhdGgiLCJmaWxlTmFtZSIsImxhc3QiLCJzcGxpdCIsImV4cG9ydENyYXNoIiwiZSIsIndhcm4iLCJtZXNzYWdlIiwiam9pbiIsInN0YXQiLCJ0aW1lc3RhbXAiLCJjdGltZSIsImdldFRpbWUiLCJsZXZlbCIsIkJvb2xlYW4iLCJyaW1yYWYiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7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QVVsQixPQUFWLENBQU47QUFDRDtBQUNGOztBQTNHZTs7O2VBK0dIcEQsVyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGZzLCB0ZW1wRGlyIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IHsgdXRpbGl0aWVzIH0gZnJvbSAnYXBwaXVtLWlvcy1kZXZpY2UnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IFB5aWRldmljZSBmcm9tICcuLi9weS1pb3MtZGV2aWNlLWNsaWVudCc7XG5cbmNvbnN0IFJFQUxfREVWSUNFX01BR0lDID0gJzM2MjBiYmIwLWZiOWYtNGI2Mi1hNjY4LTg5NmYyZWRjNGQ4OCc7XG5jb25zdCBNQUdJQ19TRVAgPSAnLyc7XG5cblxuY2xhc3MgSU9TQ3Jhc2hMb2cge1xuICBjb25zdHJ1Y3RvciAob3B0cyA9IHt9KSB7XG4gICAgdGhpcy51ZGlkID0gb3B0cy51ZGlkO1xuICAgIHRoaXMucHlpZGV2aWNlQ2xpZW50ID0gdGhpcy51ZGlkID8gbmV3IFB5aWRldmljZSh0aGlzLnVkaWQpIDogbnVsbDtcbiAgICBjb25zdCBsb2dEaXIgPSBvcHRzLnVkaWRcbiAgICAgID8gcGF0aC5yZXNvbHZlKHByb2Nlc3MuZW52LkhPTUUsICdMaWJyYXJ5JywgJ0xvZ3MnLCAnQ3Jhc2hSZXBvcnRlcicsICdNb2JpbGVEZXZpY2UnKVxuICAgICAgOiBwYXRoLnJlc29sdmUocHJvY2Vzcy5lbnYuSE9NRSwgJ0xpYnJhcnknLCAnTG9ncycsICdEaWFnbm9zdGljUmVwb3J0cycpO1xuICAgIHRoaXMubG9nRGlyID0gbG9nRGlyXG4gICAgICB8fCBwYXRoLnJlc29sdmUocHJvY2Vzcy5lbnYuSE9NRSB8fCAnLycsICdMaWJyYXJ5JywgJ0xvZ3MnLCAnRGlhZ25vc3RpY1JlcG9ydHMnKTtcbiAgICB0aGlzLnByZXZMb2dzID0gW107XG4gICAgdGhpcy5sb2dzU2luY2VMYXN0UmVxdWVzdCA9IFtdO1xuICAgIHRoaXMucGhvbmVOYW1lID0gbnVsbDtcbiAgICB0aGlzLnNpbSA9IG9wdHMuc2ltO1xuICB9XG5cbiAgYXN5bmMgX2dhdGhlckZyb21SZWFsRGV2aWNlICgpIHtcbiAgICBpZiAoYXdhaXQgdGhpcy5weWlkZXZpY2VDbGllbnQuYXNzZXJ0RXhpc3RzKGZhbHNlKSkge1xuICAgICAgcmV0dXJuIChhd2FpdCB0aGlzLnB5aWRldmljZUNsaWVudC5saXN0Q3Jhc2hlcygpKVxuICAgICAgICAubWFwKCh4KSA9PiBgJHtSRUFMX0RFVklDRV9NQUdJQ30ke01BR0lDX1NFUH0ke3h9YCk7XG4gICAgfVxuXG4gICAgbGV0IGNyYXNoTG9nc1Jvb3QgPSB0aGlzLmxvZ0RpcjtcbiAgICBpZiAodGhpcy51ZGlkKSB7XG4gICAgICB0aGlzLnBob25lTmFtZSA9IHRoaXMucGhvbmVOYW1lIHx8IGF3YWl0IHV0aWxpdGllcy5nZXREZXZpY2VOYW1lKHRoaXMudWRpZCk7XG4gICAgICBjcmFzaExvZ3NSb290ID0gcGF0aC5yZXNvbHZlKGNyYXNoTG9nc1Jvb3QsIHRoaXMucGhvbmVOYW1lKTtcbiAgICB9XG4gICAgaWYgKCFhd2FpdCBmcy5leGlzdHMoY3Jhc2hMb2dzUm9vdCkpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgQ3Jhc2ggcmVwb3J0cyByb290ICcke2NyYXNoTG9nc1Jvb3R9JyBkb2VzIG5vdCBleGlzdC4gR290IG5vdGhpbmcgdG8gZ2F0aGVyLmApO1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgICBjb25zdCBmb3VuZEZpbGVzID0gYXdhaXQgZnMuZ2xvYihgJHtjcmFzaExvZ3NSb290fS8qKi8qLmNyYXNoYCwge1xuICAgICAgc3RyaWN0OiBmYWxzZVxuICAgIH0pO1xuICAgIHJldHVybiBmb3VuZEZpbGVzO1xuICB9XG5cbiAgYXN5bmMgX2dhdGhlckZyb21TaW11bGF0b3IgKCkge1xuICAgIGlmICghYXdhaXQgZnMuZXhpc3RzKHRoaXMubG9nRGlyKSkge1xuICAgICAgbG9nLmRlYnVnKGBDcmFzaCByZXBvcnRzIHJvb3QgJyR7dGhpcy5sb2dEaXJ9JyBkb2VzIG5vdCBleGlzdC4gR290IG5vdGhpbmcgdG8gZ2F0aGVyLmApO1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgICBjb25zdCBmb3VuZEZpbGVzID0gYXdhaXQgZnMuZ2xvYihgJHt0aGlzLmxvZ0Rpcn0vKiovKi5jcmFzaGAsIHtcbiAgICAgIHN0cmljdDogZmFsc2VcbiAgICB9KTtcbiAgICAvLyBGb3IgU2ltdWxhdG9yIG9ubHkgaW5jbHVkZSBmaWxlcywgdGhhdCBjb250YWluIGN1cnJlbnQgVURJRFxuICAgIHJldHVybiBhd2FpdCBCLmZpbHRlcihmb3VuZEZpbGVzLCBhc3luYyAoeCkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgY29udGVudCA9IGF3YWl0IGZzLnJlYWRGaWxlKHgsICd1dGY4Jyk7XG4gICAgICAgIHJldHVybiBjb250ZW50LnRvVXBwZXJDYXNlKCkuaW5jbHVkZXModGhpcy5zaW0udWRpZC50b1VwcGVyQ2FzZSgpKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBnZXRDcmFzaGVzICgpIHtcbiAgICByZXR1cm4gdGhpcy51ZGlkXG4gICAgICA/IGF3YWl0IHRoaXMuX2dhdGhlckZyb21SZWFsRGV2aWNlKClcbiAgICAgIDogYXdhaXQgdGhpcy5fZ2F0aGVyRnJvbVNpbXVsYXRvcigpO1xuICB9XG5cbiAgYXN5bmMgc3RhcnRDYXB0dXJlICgpIHtcbiAgICB0aGlzLnByZXZMb2dzID0gYXdhaXQgdGhpcy5nZXRDcmFzaGVzKCk7XG4gIH1cblxuICBhc3luYyBzdG9wQ2FwdHVyZSAoKSB7XG4gICAgLy8gbmVlZGVkIGZvciBjb25zaXN0ZW50IEFQSSB3aXRoIG90aGVyIGxvZ3NcbiAgfVxuXG4gIGFzeW5jIGdldExvZ3MgKCkge1xuICAgIGxldCBjcmFzaEZpbGVzID0gYXdhaXQgdGhpcy5nZXRDcmFzaGVzKCk7XG4gICAgbGV0IGRpZmYgPSBfLmRpZmZlcmVuY2UoY3Jhc2hGaWxlcywgdGhpcy5wcmV2TG9ncywgdGhpcy5sb2dzU2luY2VMYXN0UmVxdWVzdCk7XG4gICAgdGhpcy5sb2dzU2luY2VMYXN0UmVxdWVzdCA9IF8udW5pb24odGhpcy5sb2dzU2luY2VMYXN0UmVxdWVzdCwgZGlmZik7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZmlsZXNUb0pTT04oZGlmZik7XG4gIH1cblxuICBhc3luYyBnZXRBbGxMb2dzICgpIHtcbiAgICBsZXQgY3Jhc2hGaWxlcyA9IGF3YWl0IHRoaXMuZ2V0Q3Jhc2hlcygpO1xuICAgIGxldCBsb2dGaWxlcyA9IF8uZGlmZmVyZW5jZShjcmFzaEZpbGVzLCB0aGlzLnByZXZMb2dzKTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5maWxlc1RvSlNPTihsb2dGaWxlcyk7XG4gIH1cblxuICBhc3luYyBmaWxlc1RvSlNPTiAocGF0aHMpIHtcbiAgICBjb25zdCB0bXBSb290ID0gYXdhaXQgdGVtcERpci5vcGVuRGlyKCk7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiAoYXdhaXQgQi5tYXAocGF0aHMsIGFzeW5jIChmdWxsUGF0aCkgPT4ge1xuICAgICAgICBpZiAoXy5pbmNsdWRlcyhmdWxsUGF0aCwgUkVBTF9ERVZJQ0VfTUFHSUMpKSB7XG4gICAgICAgICAgY29uc3QgZmlsZU5hbWUgPSBfLmxhc3QoZnVsbFBhdGguc3BsaXQoTUFHSUNfU0VQKSk7XG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMucHlpZGV2aWNlQ2xpZW50LmV4cG9ydENyYXNoKGZpbGVOYW1lLCB0bXBSb290KTtcbiAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICBsb2cud2FybihgQ2Fubm90IGV4cG9ydCB0aGUgY3Jhc2ggcmVwb3J0ICcke2ZpbGVOYW1lfScuIFNraXBwaW5nIGl0LiBgICtcbiAgICAgICAgICAgICAgYE9yaWdpbmFsIGVycm9yOiAke2UubWVzc2FnZX1gKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICB9XG4gICAgICAgICAgZnVsbFBhdGggPSBwYXRoLmpvaW4odG1wUm9vdCwgZmlsZU5hbWUpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHN0YXQgPSBhd2FpdCBmcy5zdGF0KGZ1bGxQYXRoKTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICB0aW1lc3RhbXA6IHN0YXQuY3RpbWUuZ2V0VGltZSgpLFxuICAgICAgICAgIGxldmVsOiAnQUxMJyxcbiAgICAgICAgICBtZXNzYWdlOiBhd2FpdCBmcy5yZWFkRmlsZShmdWxsUGF0aCwgJ3V0ZjgnKVxuICAgICAgICB9O1xuICAgICAgfSkpLmZpbHRlcihCb29sZWFuKTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgYXdhaXQgZnMucmltcmFmKHRtcFJvb3QpO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgeyBJT1NDcmFzaExvZyB9O1xuZXhwb3J0IGRlZmF1bHQgSU9TQ3Jhc2hMb2c7XG4iXSwiZmlsZSI6ImxpYi9kZXZpY2UtbG9nL2lvcy1jcmFzaC1sb2cuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
