"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.pullFile = pullFile;
exports.pullFolder = pullFolder;
exports.pushFile = pushFile;
exports.pushFolder = pushFolder;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _appiumSupport = require("appium-support");

var _path = _interopRequireDefault(require("path"));

var _logger = _interopRequireDefault(require("./logger"));

const IO_TIMEOUT_MS = 4 * 60 * 1000;
const MAX_IO_CHUNK_SIZE = 8;

async function pullFile(afcService, remotePath) {
  const stream = await afcService.createReadStream(remotePath, {
    autoDestroy: true
  });
  const pullPromise = new _bluebird.default((resolve, reject) => {
    stream.on('close', resolve);
    stream.on('error', reject);
  }).timeout(IO_TIMEOUT_MS);
  const buffers = [];
  stream.on('data', data => buffers.push(data));
  await pullPromise;
  return Buffer.concat(buffers);
}

async function folderExists(folderPath) {
  try {
    return (await _appiumSupport.fs.stat(folderPath)).isDirectory();
  } catch (e) {
    return false;
  }
}

async function pullFolder(afcService, remoteRootPath) {
  const tmpFolder = await _appiumSupport.tempDir.openDir();

  try {
    let localTopItem = null;
    let countFilesSuccess = 0;
    let countFilesFail = 0;
    let countFolders = 0;
    const pullPromises = [];
    await afcService.walkDir(remoteRootPath, true, async (remotePath, isDir) => {
      const localPath = _path.default.join(tmpFolder, remotePath);

      const dirname = isDir ? localPath : _path.default.dirname(localPath);

      if (!(await folderExists(dirname))) {
        await (0, _appiumSupport.mkdirp)(dirname);
      }

      if (!localTopItem || localPath.split(_path.default.sep).length < localTopItem.split(_path.default.sep).length) {
        localTopItem = localPath;
      }

      if (isDir) {
        ++countFolders;
        return;
      }

      const readStream = await afcService.createReadStream(remotePath, {
        autoDestroy: true
      });

      const writeStream = _appiumSupport.fs.createWriteStream(localPath, {
        autoClose: true
      });

      pullPromises.push(new _bluebird.default(resolve => {
        writeStream.on('close', () => {
          ++countFilesSuccess;
          resolve();
        });

        const onStreamingError = e => {
          readStream.unpipe(writeStream);

          _logger.default.warn(`Cannot pull '${remotePath}' to '${localPath}'. ` + `The file will be skipped. Original error: ${e.message}`);

          ++countFilesFail;
          resolve();
        };

        writeStream.on('error', onStreamingError);
        readStream.on('error', onStreamingError);
      }).timeout(IO_TIMEOUT_MS));
      readStream.pipe(writeStream);

      if (pullPromises.length >= MAX_IO_CHUNK_SIZE) {
        await _bluebird.default.any(pullPromises);
      }

      _lodash.default.remove(pullPromises, p => p.isFulfilled());
    });

    if (!_lodash.default.isEmpty(pullPromises)) {
      await _bluebird.default.all(pullPromises);
    }

    _logger.default.info(`Pulled ${_appiumSupport.util.pluralize('file', countFilesSuccess, true)} out of ` + `${countFilesSuccess + countFilesFail} and ${_appiumSupport.util.pluralize('folder', countFolders, true)} ` + `from '${remoteRootPath}'`);

    return await _appiumSupport.zip.toInMemoryZip(localTopItem ? _path.default.dirname(localTopItem) : tmpFolder, {
      encodeToBase64: true
    });
  } finally {
    await _appiumSupport.fs.rimraf(tmpFolder);
  }
}

async function remoteMkdirp(afcService, remoteRoot) {
  if (remoteRoot === '.' || remoteRoot === '/') {
    return;
  }

  try {
    await afcService.listDirectory(remoteRoot);
    return;
  } catch (e) {
    await remoteMkdirp(afcService, _path.default.dirname(remoteRoot));
  }

  await afcService.createDirectory(remoteRoot);
}

async function pushFile(afcService, remotePath, base64Data) {
  await remoteMkdirp(afcService, _path.default.dirname(remotePath));
  const stream = await afcService.createWriteStream(remotePath, {
    autoDestroy: true
  });
  let pushError = null;
  const pushPromise = new _bluebird.default((resolve, reject) => {
    stream.on('error', e => {
      pushError = e;
    });
    stream.on('close', () => {
      if (pushError) {
        reject(pushError);
      } else {
        resolve();
      }
    });
  }).timeout(IO_TIMEOUT_MS);
  stream.write(Buffer.from(base64Data, 'base64'));
  stream.end();
  await pushPromise;
}

async function pushFolder(afcService, srcRootPath, dstRootPath, opts = {}) {
  const {
    timeoutMs = IO_TIMEOUT_MS,
    enableParallelPush = false
  } = opts;
  const timer = new _appiumSupport.timing.Timer().start();
  const itemsToPush = await _appiumSupport.fs.glob('**', {
    cwd: srcRootPath,
    nosort: true,
    mark: true
  });

  _logger.default.debug(`Successfully scanned the tree structure of '${srcRootPath}'`);

  const [foldersToPush, filesToPush] = itemsToPush.reduce((acc, x) => {
    acc[_lodash.default.endsWith(x, _path.default.sep) ? 0 : 1].push(x);
    return acc;
  }, [[], []]);

  _logger.default.debug(`Got ${_appiumSupport.util.pluralize('folder', foldersToPush.length, true)} and ` + `${_appiumSupport.util.pluralize('file', filesToPush.length, true)} to push`);

  try {
    await afcService.deleteDirectory(dstRootPath);
  } catch (ign) {}

  await afcService.createDirectory(dstRootPath);
  const foldersToPushByHierarchy = foldersToPush.sort((a, b) => a.split(_path.default.sep).length - b.split(_path.default.sep).length);

  for (const relativeFolderPath of foldersToPushByHierarchy) {
    const absoluteFolderPath = _lodash.default.trimEnd(_path.default.join(dstRootPath, relativeFolderPath), _path.default.sep);

    if (absoluteFolderPath) {
      await afcService.createDirectory(absoluteFolderPath);
    }
  }

  _logger.default.debug(`Successfully created the remote folder structure ` + `(${_appiumSupport.util.pluralize('item', foldersToPush.length + 1, true)})`);

  const pushFile = async relativePath => {
    const absoluteSourcePath = _path.default.join(srcRootPath, relativePath);

    const readStream = _appiumSupport.fs.createReadStream(absoluteSourcePath, {
      autoClose: true
    });

    const absoluteDestinationPath = _path.default.join(dstRootPath, relativePath);

    const writeStream = await afcService.createWriteStream(absoluteDestinationPath, {
      autoDestroy: true
    });
    writeStream.on('finish', writeStream.destroy);
    let pushError = null;
    const filePushPromise = new _bluebird.default((resolve, reject) => {
      writeStream.on('close', () => {
        if (pushError) {
          reject(pushError);
        } else {
          resolve();
        }
      });

      const onStreamError = e => {
        readStream.unpipe(writeStream);

        _logger.default.debug(e);

        pushError = e;
      };

      writeStream.on('error', onStreamError);
      readStream.on('error', onStreamError);
    });
    readStream.pipe(writeStream);
    await filePushPromise.timeout(timeoutMs);
  };

  if (enableParallelPush) {
    _logger.default.debug(`Proceeding to parallel files push (max ${MAX_IO_CHUNK_SIZE} writers)`);

    const pushPromises = [];

    for (const relativeFilePath of _lodash.default.shuffle(filesToPush)) {
      pushPromises.push(_bluebird.default.resolve(pushFile(relativeFilePath)));

      if (pushPromises.length >= MAX_IO_CHUNK_SIZE) {
        await _bluebird.default.any(pushPromises);
      }

      _lodash.default.remove(pushPromises, p => p.isFulfilled());
    }

    if (!_lodash.default.isEmpty(pushPromises)) {
      await _bluebird.default.all(pushPromises);
    }
  } else {
    _logger.default.debug(`Proceeding to serial files push`);

    for (const relativeFilePath of filesToPush) {
      await pushFile(relativeFilePath);
    }
  }

  _logger.default.debug(`Successfully pushed ${_appiumSupport.util.pluralize('folder', foldersToPush.length, true)} ` + `and ${_appiumSupport.util.pluralize('file', filesToPush.length, true)} ` + `within ${timer.getDuration().asMilliSeconds.toFixed(0)}ms`);
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9pb3MtZnMtaGVscGVycy5qcyJdLCJuYW1lcyI6WyJJT19USU1FT1VUX01TIiwiTUFYX0lPX0NIVU5LX1NJWkUiLCJwdWxsRmlsZSIsImFmY1NlcnZpY2UiLCJyZW1vdGVQYXRoIiwic3RyZWFtIiwiY3JlYXRlUmVhZFN0cmVhbSIsImF1dG9EZXN0cm95IiwicHVsbFByb21pc2UiLCJCIiwicmVzb2x2ZSIsInJlamVjdCIsIm9uIiwidGltZW91dCIsImJ1ZmZlcnMiLCJkYXRhIiwicHVzaCIsIkJ1ZmZlciIsImNvbmNhdCIsImZvbGRlckV4aXN0cyIsImZvbGRlclBhdGgiLCJmcyIsInN0YXQiLCJpc0RpcmVjdG9yeSIsImUiLCJwdWxsRm9sZGVyIiwicmVtb3RlUm9vdFBhdGgiLCJ0bXBGb2xkZXIiLCJ0ZW1wRGlyIiwib3BlbkRpciIsImxvY2FsVG9wSXRlbSIsImNvdW50RmlsZXNTdWNjZXNzIiwiY291bnRGaWxlc0ZhaWwiLCJjb3VudEZvbGRlcnMiLCJwdWxsUHJvbWlzZXMiLCJ3YWxrRGlyIiwiaXNEaXIiLCJsb2NhbFBhdGgiLCJwYXRoIiwiam9pbiIsImRpcm5hbWUiLCJzcGxpdCIsInNlcCIsImxlbmd0aCIsInJlYWRTdHJlYW0iLCJ3cml0ZVN0cmVhbSIsImNyZWF0ZVdyaXRlU3RyZWFtIiwiYXV0b0Nsb3NlIiwib25TdHJlYW1pbmdFcnJvciIsInVucGlwZSIsImxvZyIsIndhcm4iLCJtZXNzYWdlIiwicGlwZSIsImFueSIsIl8iLCJyZW1vdmUiLCJwIiwiaXNGdWxmaWxsZWQiLCJpc0VtcHR5IiwiYWxsIiwiaW5mbyIsInV0aWwiLCJwbHVyYWxpemUiLCJ6aXAiLCJ0b0luTWVtb3J5WmlwIiwiZW5jb2RlVG9CYXNlNjQiLCJyaW1yYWYiLCJyZW1vdGVNa2RpcnAiLCJyZW1vdGVSb290IiwibGlzdERpcmVjdG9yeSIsImNyZWF0ZURpcmVjdG9yeSIsInB1c2hGaWxlIiwiYmFzZTY0RGF0YSIsInB1c2hFcnJvciIsInB1c2hQcm9taXNlIiwid3JpdGUiLCJmcm9tIiwiZW5kIiwicHVzaEZvbGRlciIsInNyY1Jvb3RQYXRoIiwiZHN0Um9vdFBhdGgiLCJvcHRzIiwidGltZW91dE1zIiwiZW5hYmxlUGFyYWxsZWxQdXNoIiwidGltZXIiLCJ0aW1pbmciLCJUaW1lciIsInN0YXJ0IiwiaXRlbXNUb1B1c2giLCJnbG9iIiwiY3dkIiwibm9zb3J0IiwibWFyayIsImRlYnVnIiwiZm9sZGVyc1RvUHVzaCIsImZpbGVzVG9QdXNoIiwicmVkdWNlIiwiYWNjIiwieCIsImVuZHNXaXRoIiwiZGVsZXRlRGlyZWN0b3J5IiwiaWduIiwiZm9sZGVyc1RvUHVzaEJ5SGllcmFyY2h5Iiwic29ydCIsImEiLCJiIiwicmVsYXRpdmVGb2xkZXJQYXRoIiwiYWJzb2x1dGVGb2xkZXJQYXRoIiwidHJpbUVuZCIsInJlbGF0aXZlUGF0aCIsImFic29sdXRlU291cmNlUGF0aCIsImFic29sdXRlRGVzdGluYXRpb25QYXRoIiwiZGVzdHJveSIsImZpbGVQdXNoUHJvbWlzZSIsIm9uU3RyZWFtRXJyb3IiLCJwdXNoUHJvbWlzZXMiLCJyZWxhdGl2ZUZpbGVQYXRoIiwic2h1ZmZsZSIsImdldER1cmF0aW9uIiwiYXNNaWxsaVNlY29uZHMiLCJ0b0ZpeGVkIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLE1BQU1BLGFBQWEsR0FBRyxJQUFJLEVBQUosR0FBUyxJQUEvQjtBQUdBLE1BQU1DLGlCQUFpQixHQUFHLENBQTFCOztBQVVBLGVBQWVDLFFBQWYsQ0FBeUJDLFVBQXpCLEVBQXFDQyxVQUFyQyxFQUFpRDtBQUMvQyxRQUFNQyxNQUFNLEdBQUcsTUFBTUYsVUFBVSxDQUFDRyxnQkFBWCxDQUE0QkYsVUFBNUIsRUFBd0M7QUFBRUcsSUFBQUEsV0FBVyxFQUFFO0FBQWYsR0FBeEMsQ0FBckI7QUFDQSxRQUFNQyxXQUFXLEdBQUcsSUFBSUMsaUJBQUosQ0FBTSxDQUFDQyxPQUFELEVBQVVDLE1BQVYsS0FB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QWQ7QUFDRDtBQUNGOztBQUVEbkUsa0JBQUk0QyxLQUFKLENBQVcsdUJBQXNCaEMsb0JBQUtDLFNBQUwsQ0FBZSxRQUFmLEVBQXlCZ0MsYUFBYSxDQUFDcEQsTUFBdkMsRUFBK0MsSUFBL0MsQ0FBcUQsR0FBNUUsR0FDUCxPQUFNbUIsb0JBQUtDLFNBQUwsQ0FBZSxNQUFmLEVBQXVCaUMsV0FBVyxDQUFDckQsTUFBbkMsRUFBMkMsSUFBM0MsQ0FBaUQsR0FEaEQsR0FFUCxVQUFTMEMsS0FBSyxDQUFDa0MsV0FBTixHQUFvQkMsY0FBcEIsQ0FBbUNDLE9BQW5DLENBQTJDLENBQTNDLENBQThDLElBRjFEO0FBR0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHsgZnMsIHRlbXBEaXIsIG1rZGlycCwgemlwLCB1dGlsLCB0aW1pbmcgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuXG5jb25zdCBJT19USU1FT1VUX01TID0gNCAqIDYwICogMTAwMDtcbi8vIE1vYmlsZSBkZXZpY2VzIHVzZSBOQU5EIG1lbW9yeSBtb2R1bGVzIGZvciB0aGUgc3RvcmFnZSxcbi8vIGFuZCB0aGUgcGFyYWxsZWxpc20gdGhlcmUgaXMgbm90IGFzIHBlcmZvcm1hbnQgYXMgb24gcmVndWxhciBTU0RzXG5jb25zdCBNQVhfSU9fQ0hVTktfU0laRSA9IDg7XG5cbi8qKlxuICogUmV0cmlldmUgYSBmaWxlIGZyb20gYSByZWFsIGRldmljZVxuICpcbiAqIEBwYXJhbSB7QWZjU2VydmljZX0gYWZjU2VydmljZSBBcHBsZSBGaWxlIENsaWVudCBzZXJ2aWNlIGluc3RhbmNlIGZyb21cbiAqICdhcHBpdW0taW9zLWRldmljZScgbW9kdWxlXG4gKiBAcGFyYW0ge3N0cmluZ30gcmVtb3RlUGF0aCBSZWxhdGl2ZSBwYXRoIHRvIHRoZSBmaWxlIG9uIHRoZSBkZXZpY2VcbiAqIEByZXR1cm5zIHtCdWZmZXJ9IFRoZSBmaWxlIGNvbnRlbnQgYXMgYSBidWZmZXJcbiAqL1xuYXN5bmMgZnVuY3Rpb24gcHVsbEZpbGUgKGFmY1NlcnZpY2UsIHJlbW90ZVBhdGgpIHtcbiAgY29uc3Qgc3RyZWFtID0gYXdhaXQgYWZjU2VydmljZS5jcmVhdGVSZWFkU3RyZWFtKHJlbW90ZVBhdGgsIHsgYXV0b0Rlc3Ryb3k6IHRydWUgfSk7XG4gIGNvbnN0IHB1bGxQcm9taXNlID0gbmV3IEIoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIHN0cmVhbS5vbignY2xvc2UnLCByZXNvbHZlKTtcbiAgICBzdHJlYW0ub24oJ2Vycm9yJywgcmVqZWN0KTtcbiAgfSkudGltZW91dChJT19USU1FT1VUX01TKTtcbiAgY29uc3QgYnVmZmVycyA9IFtdO1xuICBzdHJlYW0ub24oJ2RhdGEnLCAoZGF0YSkgPT4gYnVmZmVycy5wdXNoKGRhdGEpKTtcbiAgYXdhaXQgcHVsbFByb21pc2U7XG4gIHJldHVybiBCdWZmZXIuY29uY2F0KGJ1ZmZlcnMpO1xufVxuXG4vKipcbiAqIENoZWNrcyBhIHByZXNlbmNlIG9mIGEgbG9jYWwgZm9sZGVyLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBmb2xkZXJQYXRoIEZ1bGwgcGF0aCB0byB0aGUgbG9jYWwgZm9sZGVyXG4gKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgZm9sZGVyIGV4aXN0cyBhbmQgaXMgYWN0dWFsbHkgYSBmb2xkZXJcbiAqL1xuYXN5bmMgZnVuY3Rpb24gZm9sZGVyRXhpc3RzIChmb2xkZXJQYXRoKSB7XG4gIHRyeSB7XG4gICAgcmV0dXJuIChhd2FpdCBmcy5zdGF0KGZvbGRlclBhdGgpKS5pc0RpcmVjdG9yeSgpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG59XG5cbi8qKlxuICogUmV0cmlldmUgYSBmb2xkZXIgZnJvbSBhIHJlYWwgZGV2aWNlXG4gKlxuICogQHBhcmFtIHtBZmNTZXJ2aWNlfSBhZmNTZXJ2aWNlIEFwcGxlIEZpbGUgQ2xpZW50IHNlcnZpY2UgaW5zdGFuY2UgZnJvbVxuICogJ2FwcGl1bS1pb3MtZGV2aWNlJyBtb2R1bGVcbiAqIEBwYXJhbSB7c3RyaW5nfSByZW1vdGVSb290UGF0aCBSZWxhdGl2ZSBwYXRoIHRvIHRoZSBmb2xkZXIgb24gdGhlIGRldmljZVxuICogQHJldHVybnMge0J1ZmZlcn0gVGhlIGZvbGRlciBjb250ZW50IGFzIGEgemlwcGVkIGJhc2U2NC1lbmNvZGVkIGJ1ZmZlclxuICovXG5hc3luYyBmdW5jdGlvbiBwdWxsRm9sZGVyIChhZmNTZXJ2aWNlLCByZW1vdGVSb290UGF0aCkge1xuICBjb25zdCB0bXBGb2xkZXIgPSBhd2FpdCB0ZW1wRGlyLm9wZW5EaXIoKTtcbiAgdHJ5IHtcbiAgICBsZXQgbG9jYWxUb3BJdGVtID0gbnVsbDtcbiAgICBsZXQgY291bnRGaWxlc1N1Y2Nlc3MgPSAwO1xuICAgIGxldCBjb3VudEZpbGVzRmFpbCA9IDA7XG4gICAgbGV0IGNvdW50Rm9sZGVycyA9IDA7XG4gICAgY29uc3QgcHVsbFByb21pc2VzID0gW107XG4gICAgYXdhaXQgYWZjU2VydmljZS53YWxrRGlyKHJlbW90ZVJvb3RQYXRoLCB0cnVlLCBhc3luYyAocmVtb3RlUGF0aCwgaXNEaXIpID0+IHtcbiAgICAgIGNvbnN0IGxvY2FsUGF0aCA9IHBhdGguam9pbih0bXBGb2xkZXIsIHJlbW90ZVBhdGgpO1xuICAgICAgY29uc3QgZGlybmFtZSA9IGlzRGlyID8gbG9jYWxQYXRoIDogcGF0aC5kaXJuYW1lKGxvY2FsUGF0aCk7XG4gICAgICBpZiAoIWF3YWl0IGZvbGRlckV4aXN0cyhkaXJuYW1lKSkge1xuICAgICAgICBhd2FpdCBta2RpcnAoZGlybmFtZSk7XG4gICAgICB9XG4gICAgICBpZiAoIWxvY2FsVG9wSXRlbVxuICAgICAgICAgIHx8IGxvY2FsUGF0aC5zcGxpdChwYXRoLnNlcCkubGVuZ3RoIDwgbG9jYWxUb3BJdGVtLnNwbGl0KHBhdGguc2VwKS5sZW5ndGgpIHtcbiAgICAgICAgbG9jYWxUb3BJdGVtID0gbG9jYWxQYXRoO1xuICAgICAgfVxuICAgICAgaWYgKGlzRGlyKSB7XG4gICAgICAgICsrY291bnRGb2xkZXJzO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHJlYWRTdHJlYW0gPSBhd2FpdCBhZmNTZXJ2aWNlLmNyZWF0ZVJlYWRTdHJlYW0ocmVtb3RlUGF0aCwge2F1dG9EZXN0cm95OiB0cnVlfSk7XG4gICAgICBjb25zdCB3cml0ZVN0cmVhbSA9IGZzLmNyZWF0ZVdyaXRlU3RyZWFtKGxvY2FsUGF0aCwge2F1dG9DbG9zZTogdHJ1ZX0pO1xuICAgICAgcHVsbFByb21pc2VzLnB1c2goXG4gICAgICAgIG5ldyBCKChyZXNvbHZlKSA9PiB7XG4gICAgICAgICAgd3JpdGVTdHJlYW0ub24oJ2Nsb3NlJywgKCkgPT4ge1xuICAgICAgICAgICAgKytjb3VudEZpbGVzU3VjY2VzcztcbiAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgICBjb25zdCBvblN0cmVhbWluZ0Vycm9yID0gKGUpID0+IHtcbiAgICAgICAgICAgIHJlYWRTdHJlYW0udW5waXBlKHdyaXRlU3RyZWFtKTtcbiAgICAgICAgICAgIGxvZy53YXJuKGBDYW5ub3QgcHVsbCAnJHtyZW1vdGVQYXRofScgdG8gJyR7bG9jYWxQYXRofScuIGAgK1xuICAgICAgICAgICAgICBgVGhlIGZpbGUgd2lsbCBiZSBza2lwcGVkLiBPcmlnaW5hbCBlcnJvcjogJHtlLm1lc3NhZ2V9YCk7XG4gICAgICAgICAgICArK2NvdW50RmlsZXNGYWlsO1xuICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgIH07XG4gICAgICAgICAgd3JpdGVTdHJlYW0ub24oJ2Vycm9yJywgb25TdHJlYW1pbmdFcnJvcik7XG4gICAgICAgICAgcmVhZFN0cmVhbS5vbignZXJyb3InLCBvblN0cmVhbWluZ0Vycm9yKTtcbiAgICAgICAgfSkudGltZW91dChJT19USU1FT1VUX01TKVxuICAgICAgKTtcbiAgICAgIHJlYWRTdHJlYW0ucGlwZSh3cml0ZVN0cmVhbSk7XG4gICAgICBpZiAocHVsbFByb21pc2VzLmxlbmd0aCA+PSBNQVhfSU9fQ0hVTktfU0laRSkge1xuICAgICAgICBhd2FpdCBCLmFueShwdWxsUHJvbWlzZXMpO1xuICAgICAgfVxuICAgICAgXy5yZW1vdmUocHVsbFByb21pc2VzLCAocCkgPT4gcC5pc0Z1bGZpbGxlZCgpKTtcbiAgICB9KTtcbiAgICAvLyBXYWl0IGZvciB0aGUgcmVzdCBvZiBmaWxlcyB0byBiZSBwdWxsZWRcbiAgICBpZiAoIV8uaXNFbXB0eShwdWxsUHJvbWlzZXMpKSB7XG4gICAgICBhd2FpdCBCLmFsbChwdWxsUHJvbWlzZXMpO1xuICAgIH1cbiAgICBsb2cuaW5mbyhgUHVsbGVkICR7dXRpbC5wbHVyYWxpemUoJ2ZpbGUnLCBjb3VudEZpbGVzU3VjY2VzcywgdHJ1ZSl9IG91dCBvZiBgICtcbiAgICAgIGAke2NvdW50RmlsZXNTdWNjZXNzICsgY291bnRGaWxlc0ZhaWx9IGFuZCAke3V0aWwucGx1cmFsaXplKCdmb2xkZXInLCBjb3VudEZvbGRlcnMsIHRydWUpfSBgICtcbiAgICAgIGBmcm9tICcke3JlbW90ZVJvb3RQYXRofSdgKTtcbiAgICByZXR1cm4gYXdhaXQgemlwLnRvSW5NZW1vcnlaaXAobG9jYWxUb3BJdGVtID8gcGF0aC5kaXJuYW1lKGxvY2FsVG9wSXRlbSkgOiB0bXBGb2xkZXIsIHtcbiAgICAgIGVuY29kZVRvQmFzZTY0OiB0cnVlLFxuICAgIH0pO1xuICB9IGZpbmFsbHkge1xuICAgIGF3YWl0IGZzLnJpbXJhZih0bXBGb2xkZXIpO1xuICB9XG59XG5cbi8qKlxuICogQ3JlYXRlcyByZW1vdGUgZm9sZGVyIHBhdGggcmVjdXJzaXZlbHkuIE5vb3AgaWYgdGhlIGdpdmVuIHBhdGhcbiAqIGFscmVhZHkgZXhpc3RzXG4gKlxuICogQHBhcmFtIHtBZmNTZXJ2aWNlfSBhZmNTZXJ2aWNlIEFwcGxlIEZpbGUgQ2xpZW50IHNlcnZpY2UgaW5zdGFuY2UgZnJvbVxuICogJ2FwcGl1bS1pb3MtZGV2aWNlJyBtb2R1bGVcbiAqIEBwYXJhbSB7c3RyaW5nfSByZW1vdGVSb290IFRoZSByZWxhdGl2ZSBwYXRoIHRvIHRoZSByZW1vdGUgZm9sZGVyIHN0cnVjdHVyZVxuICogdG8gYmUgY3JlYXRlZFxuICovXG5hc3luYyBmdW5jdGlvbiByZW1vdGVNa2RpcnAgKGFmY1NlcnZpY2UsIHJlbW90ZVJvb3QpIHtcbiAgaWYgKHJlbW90ZVJvb3QgPT09ICcuJyB8fCByZW1vdGVSb290ID09PSAnLycpIHtcbiAgICByZXR1cm47XG4gIH1cbiAgdHJ5IHtcbiAgICBhd2FpdCBhZmNTZXJ2aWNlLmxpc3REaXJlY3RvcnkocmVtb3RlUm9vdCk7XG4gICAgcmV0dXJuO1xuICB9IGNhdGNoIChlKSB7XG4gICAgLy8gVGhpcyBtZWFucyB0aGF0IHRoZSBkaXJlY3RvcnkgaXMgbWlzc2luZyBhbmQgd2UgZ290IGFuIG9iamVjdCBub3QgZm91bmQgZXJyb3IuXG4gICAgLy8gVGhlcmVmb3JlLCB3ZSBhcmUgZ29pbmcgdG8gdGhlIHBhcmVudFxuICAgIGF3YWl0IHJlbW90ZU1rZGlycChhZmNTZXJ2aWNlLCBwYXRoLmRpcm5hbWUocmVtb3RlUm9vdCkpO1xuICB9XG4gIGF3YWl0IGFmY1NlcnZpY2UuY3JlYXRlRGlyZWN0b3J5KHJlbW90ZVJvb3QpO1xufVxuXG4vKipcbiAqIFB1c2hlcyBhIGZpbGUgdG8gYSByZWFsIGRldmljZVxuICpcbiAqIEBwYXJhbSB7QWZjU2VydmljZX0gYWZjU2VydmljZSBBcHBsZSBGaWxlIENsaWVudCBzZXJ2aWNlIGluc3RhbmNlIGZyb21cbiAqICdhcHBpdW0taW9zLWRldmljZScgbW9kdWxlXG4gKiBAcGFyYW0ge3N0cmluZ30gcmVtb3RlUGF0aCBSZWxhdGl2ZSBwYXRoIHRvIHRoZSBmaWxlIG9uIHRoZSBkZXZpY2UuIFRoZSByZW1vdGVcbiAqIGZvbGRlciBzdHJ1Y3R1cmUgaXMgY3JlYXRlZCBhdXRvbWF0aWNhbGx5IGlmIG5lY2Vzc2FyeS5cbiAqIEBwYXJhbSB7c3RyaW5nfSBiYXNlNjREYXRhIEJhc2U2NC1lbmNvZGVkIGNvbnRlbnQgb2YgdGhlIGZpbGUgdG8gYmUgd3JpdHRlblxuICovXG5hc3luYyBmdW5jdGlvbiBwdXNoRmlsZSAoYWZjU2VydmljZSwgcmVtb3RlUGF0aCwgYmFzZTY0RGF0YSkge1xuICBhd2FpdCByZW1vdGVNa2RpcnAoYWZjU2VydmljZSwgcGF0aC5kaXJuYW1lKHJlbW90ZVBhdGgpKTtcbiAgY29uc3Qgc3RyZWFtID0gYXdhaXQgYWZjU2VydmljZS5jcmVhdGVXcml0ZVN0cmVhbShyZW1vdGVQYXRoLCB7YXV0b0Rlc3Ryb3k6IHRydWV9KTtcbiAgbGV0IHB1c2hFcnJvciA9IG51bGw7XG4gIGNvbnN0IHB1c2hQcm9taXNlID0gbmV3IEIoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIHN0cmVhbS5vbignZXJyb3InLCAoZSkgPT4ge1xuICAgICAgcHVzaEVycm9yID0gZTtcbiAgICB9KTtcbiAgICBzdHJlYW0ub24oJ2Nsb3NlJywgKCkgPT4ge1xuICAgICAgaWYgKHB1c2hFcnJvcikge1xuICAgICAgICByZWplY3QocHVzaEVycm9yKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlc29sdmUoKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSkudGltZW91dChJT19USU1FT1VUX01TKTtcbiAgc3RyZWFtLndyaXRlKEJ1ZmZlci5mcm9tKGJhc2U2NERhdGEsICdiYXNlNjQnKSk7XG4gIHN0cmVhbS5lbmQoKTtcbiAgYXdhaXQgcHVzaFByb21pc2U7XG59XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gUHVzaEZvbGRlck9wdGlvbnNcbiAqXG4gKiBAcHJvcGVydHkge251bWJlcn0gdGltZW91dE1zIFsyNDAwMDBdIFRoZSBtYXhpbXVtIHRpbWVvdXQgdG8gd2FpdCB1bnRpbCBhXG4gKiBzaW5nbGUgZmlsZSBpcyBjb3BpZWRcbiAqIEBwYXJhbSB7Ym9vbGVhbn0gZW5hYmxlUGFyYWxsZWxQdXNoIFtmYWxzZV0gV2hldGhlciB0byBwdXNoIGZpbGVzIGluIHBhcmFsbGVsLlxuICogVGhpcyB1c3VhbGx5IGdpdmVzIGJldHRlciBwZXJmb3JtYW5jZSwgYnV0IG1pZ2h0IHNvbWV0aW1lcyBiZSBsZXNzIHN0YWJsZS5cbiAqL1xuXG4vKipcbiAqIFB1c2hlcyBhIGZvbGRlciB0byBhIHJlYWwgZGV2aWNlXG4gKlxuICogQHBhcmFtIHtBZmNTZXJ2aWNlfSBhZmNTZXJ2aWNlIEFwcGxlIEZpbGUgQ2xpZW50IHNlcnZpY2UgaW5zdGFuY2UgZnJvbVxuICogJ2FwcGl1bS1pb3MtZGV2aWNlJyBtb2R1bGVcbiAqIEBwYXJhbSB7c3RyaW5nfSBzcmNSb290UGF0aCBUaGUgZnVsbCBwYXRoIHRvIHRoZSBzb3VyY2UgZm9sZGVyXG4gKiBAcGFyYW0ge3N0cmluZ30gZHN0Um9vdFBhdGggVGhlIHJlbGF0aXZlIHBhdGggdG8gdGhlIGRlc3RpbmF0aW9uIGZvbGRlci4gVGhlIGZvbGRlclxuICogd2lsbCBiZSBkZWxldGVkIGlmIGFscmVhZHkgZXhpc3RzLlxuICogQHBhcmFtIHtQdXNoRm9sZGVyT3B0aW9uc30gb3B0c1xuICovXG5hc3luYyBmdW5jdGlvbiBwdXNoRm9sZGVyIChhZmNTZXJ2aWNlLCBzcmNSb290UGF0aCwgZHN0Um9vdFBhdGgsIG9wdHMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgdGltZW91dE1zID0gSU9fVElNRU9VVF9NUyxcbiAgICBlbmFibGVQYXJhbGxlbFB1c2ggPSBmYWxzZSxcbiAgfSA9IG9wdHM7XG5cbiAgY29uc3QgdGltZXIgPSBuZXcgdGltaW5nLlRpbWVyKCkuc3RhcnQoKTtcbiAgY29uc3QgaXRlbXNUb1B1c2ggPSBhd2FpdCBmcy5nbG9iKCcqKicsIHtcbiAgICBjd2Q6IHNyY1Jvb3RQYXRoLFxuICAgIG5vc29ydDogdHJ1ZSxcbiAgICBtYXJrOiB0cnVlLFxuICB9KTtcbiAgbG9nLmRlYnVnKGBTdWNjZXNzZnVsbHkgc2Nhbm5lZCB0aGUgdHJlZSBzdHJ1Y3R1cmUgb2YgJyR7c3JjUm9vdFBhdGh9J2ApO1xuICBjb25zdCBbZm9sZGVyc1RvUHVzaCwgZmlsZXNUb1B1c2hdID0gaXRlbXNUb1B1c2gucmVkdWNlKChhY2MsIHgpID0+IHtcbiAgICBhY2NbXy5lbmRzV2l0aCh4LCBwYXRoLnNlcCkgPyAwIDogMV0ucHVzaCh4KTtcbiAgICByZXR1cm4gYWNjO1xuICB9LCBbW10sIFtdXSk7XG4gIGxvZy5kZWJ1ZyhgR290ICR7dXRpbC5wbHVyYWxpemUoJ2ZvbGRlcicsIGZvbGRlcnNUb1B1c2gubGVuZ3RoLCB0cnVlKX0gYW5kIGAgK1xuICAgIGAke3V0aWwucGx1cmFsaXplKCdmaWxlJywgZmlsZXNUb1B1c2gubGVuZ3RoLCB0cnVlKX0gdG8gcHVzaGApO1xuICAvLyBjcmVhdGUgdGhlIGZvbGRlciBzdHJ1Y3R1cmUgZmlyc3RcbiAgdHJ5IHtcbiAgICBhd2FpdCBhZmNTZXJ2aWNlLmRlbGV0ZURpcmVjdG9yeShkc3RSb290UGF0aCk7XG4gIH0gY2F0Y2ggKGlnbikge31cbiAgYXdhaXQgYWZjU2VydmljZS5jcmVhdGVEaXJlY3RvcnkoZHN0Um9vdFBhdGgpO1xuICAvLyB0b3AtbGV2ZWwgZm9sZGVycyBtdXN0IGdvIGZpcnN0XG4gIGNvbnN0IGZvbGRlcnNUb1B1c2hCeUhpZXJhcmNoeSA9IGZvbGRlcnNUb1B1c2hcbiAgICAuc29ydCgoYSwgYikgPT4gYS5zcGxpdChwYXRoLnNlcCkubGVuZ3RoIC0gYi5zcGxpdChwYXRoLnNlcCkubGVuZ3RoKTtcbiAgZm9yIChjb25zdCByZWxhdGl2ZUZvbGRlclBhdGggb2YgZm9sZGVyc1RvUHVzaEJ5SGllcmFyY2h5KSB7XG4gICAgLy8gY3JlYXRlRGlyZWN0b3J5IGRvZXMgbm90IGFjY2VwdCBmb2xkZXIgbmFtZXMgZW5kaW5nIHdpdGggYSBwYXRoIHNlcGFyYXRvclxuICAgIGNvbnN0IGFic29sdXRlRm9sZGVyUGF0aCA9IF8udHJpbUVuZChcbiAgICAgIHBhdGguam9pbihkc3RSb290UGF0aCwgcmVsYXRpdmVGb2xkZXJQYXRoKSwgcGF0aC5zZXBcbiAgICApO1xuICAgIGlmIChhYnNvbHV0ZUZvbGRlclBhdGgpIHtcbiAgICAgIGF3YWl0IGFmY1NlcnZpY2UuY3JlYXRlRGlyZWN0b3J5KGFic29sdXRlRm9sZGVyUGF0aCk7XG4gICAgfVxuICB9XG4gIC8vIGRvIG5vdCBmb3JnZXQgYWJvdXQgdGhlIHJvb3QgZm9sZGVyXG4gIGxvZy5kZWJ1ZyhgU3VjY2Vzc2Z1bGx5IGNyZWF0ZWQgdGhlIHJlbW90ZSBmb2xkZXIgc3RydWN0dXJlIGAgK1xuICAgIGAoJHt1dGlsLnBsdXJhbGl6ZSgnaXRlbScsIGZvbGRlcnNUb1B1c2gubGVuZ3RoICsgMSwgdHJ1ZSl9KWApO1xuXG4gIGNvbnN0IHB1c2hGaWxlID0gYXN5bmMgKHJlbGF0aXZlUGF0aCkgPT4ge1xuICAgIGNvbnN0IGFic29sdXRlU291cmNlUGF0aCA9IHBhdGguam9pbihzcmNSb290UGF0aCwgcmVsYXRpdmVQYXRoKTtcbiAgICBjb25zdCByZWFkU3RyZWFtID0gZnMuY3JlYXRlUmVhZFN0cmVhbShhYnNvbHV0ZVNvdXJjZVBhdGgsIHthdXRvQ2xvc2U6IHRydWV9KTtcbiAgICBjb25zdCBhYnNvbHV0ZURlc3RpbmF0aW9uUGF0aCA9IHBhdGguam9pbihkc3RSb290UGF0aCwgcmVsYXRpdmVQYXRoKTtcbiAgICBjb25zdCB3cml0ZVN0cmVhbSA9IGF3YWl0IGFmY1NlcnZpY2UuY3JlYXRlV3JpdGVTdHJlYW0oYWJzb2x1dGVEZXN0aW5hdGlvblBhdGgsIHtcbiAgICAgIGF1dG9EZXN0cm95OiB0cnVlXG4gICAgfSk7XG4gICAgd3JpdGVTdHJlYW0ub24oJ2ZpbmlzaCcsIHdyaXRlU3RyZWFtLmRlc3Ryb3kpO1xuICAgIGxldCBwdXNoRXJyb3IgPSBudWxsO1xuICAgIGNvbnN0IGZpbGVQdXNoUHJvbWlzZSA9IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHdyaXRlU3RyZWFtLm9uKCdjbG9zZScsICgpID0+IHtcbiAgICAgICAgaWYgKHB1c2hFcnJvcikge1xuICAgICAgICAgIHJlamVjdChwdXNoRXJyb3IpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICBjb25zdCBvblN0cmVhbUVycm9yID0gKGUpID0+IHtcbiAgICAgICAgcmVhZFN0cmVhbS51bnBpcGUod3JpdGVTdHJlYW0pO1xuICAgICAgICBsb2cuZGVidWcoZSk7XG4gICAgICAgIHB1c2hFcnJvciA9IGU7XG4gICAgICB9O1xuICAgICAgd3JpdGVTdHJlYW0ub24oJ2Vycm9yJywgb25TdHJlYW1FcnJvcik7XG4gICAgICByZWFkU3RyZWFtLm9uKCdlcnJvcicsIG9uU3RyZWFtRXJyb3IpO1xuICAgIH0pO1xuICAgIHJlYWRTdHJlYW0ucGlwZSh3cml0ZVN0cmVhbSk7XG4gICAgYXdhaXQgZmlsZVB1c2hQcm9taXNlLnRpbWVvdXQodGltZW91dE1zKTtcbiAgfTtcblxuICBpZiAoZW5hYmxlUGFyYWxsZWxQdXNoKSB7XG4gICAgbG9nLmRlYnVnKGBQcm9jZWVkaW5nIHRvIHBhcmFsbGVsIGZpbGVzIHB1c2ggKG1heCAke01BWF9JT19DSFVOS19TSVpFfSB3cml0ZXJzKWApO1xuICAgIGNvbnN0IHB1c2hQcm9taXNlcyA9IFtdO1xuICAgIGZvciAoY29uc3QgcmVsYXRpdmVGaWxlUGF0aCBvZiBfLnNodWZmbGUoZmlsZXNUb1B1c2gpKSB7XG4gICAgICBwdXNoUHJvbWlzZXMucHVzaChCLnJlc29sdmUocHVzaEZpbGUocmVsYXRpdmVGaWxlUGF0aCkpKTtcbiAgICAgIC8vIGtlZXAgdGhlIHB1c2ggcXVldWUgZmlsbGVkXG4gICAgICBpZiAocHVzaFByb21pc2VzLmxlbmd0aCA+PSBNQVhfSU9fQ0hVTktfU0laRSkge1xuICAgICAgICBhd2FpdCBCLmFueShwdXNoUHJvbWlzZXMpO1xuICAgICAgfVxuICAgICAgXy5yZW1vdmUocHVzaFByb21pc2VzLCAocCkgPT4gcC5pc0Z1bGZpbGxlZCgpKTtcbiAgICB9XG4gICAgaWYgKCFfLmlzRW1wdHkocHVzaFByb21pc2VzKSkge1xuICAgICAgLy8gaGFuZGxlIHRoZSByZXN0IG9mIHB1c2ggcHJvbWlzZXNcbiAgICAgIGF3YWl0IEIuYWxsKHB1c2hQcm9taXNlcyk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGxvZy5kZWJ1ZyhgUHJvY2VlZGluZyB0byBzZXJpYWwgZmlsZXMgcHVzaGApO1xuICAgIGZvciAoY29uc3QgcmVsYXRpdmVGaWxlUGF0aCBvZiBmaWxlc1RvUHVzaCkge1xuICAgICAgYXdhaXQgcHVzaEZpbGUocmVsYXRpdmVGaWxlUGF0aCk7XG4gICAgfVxuICB9XG5cbiAgbG9nLmRlYnVnKGBTdWNjZXNzZnVsbHkgcHVzaGVkICR7dXRpbC5wbHVyYWxpemUoJ2ZvbGRlcicsIGZvbGRlcnNUb1B1c2gubGVuZ3RoLCB0cnVlKX0gYCArXG4gICAgYGFuZCAke3V0aWwucGx1cmFsaXplKCdmaWxlJywgZmlsZXNUb1B1c2gubGVuZ3RoLCB0cnVlKX0gYCArXG4gICAgYHdpdGhpbiAke3RpbWVyLmdldER1cmF0aW9uKCkuYXNNaWxsaVNlY29uZHMudG9GaXhlZCgwKX1tc2ApO1xufVxuXG5cbmV4cG9ydCB7IHB1bGxGaWxlLCBwdWxsRm9sZGVyLCBwdXNoRmlsZSwgcHVzaEZvbGRlciB9OyJdLCJmaWxlIjoibGliL2lvcy1mcy1oZWxwZXJzLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
