"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
exports.downloadWAD = downloadWAD;
exports.isAdmin = exports.getWADExecutablePath = void 0;
exports.setupWAD = setupWAD;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

var _path = _interopRequireDefault(require("path"));

var _teen_process = require("teen_process");

var _logger = _interopRequireDefault(require("./logger"));

var _es6Error = _interopRequireDefault(require("es6-error"));

var _registry = require("./registry");

const WAD_VER = '1.2.99';
const WAD_DOWNLOAD_MD5 = Object.freeze({
  x32: '23745e6ed373bc969ff7c4493e32756a',
  x64: '2923fc539f389d47754a7521ee50108e',
  arm64: 'b9af4222a3fb0d688ecfbf605d1c4500'
});
const ARCH_MAPPING = Object.freeze({
  x32: 'x86',
  x64: 'x64',
  arm64: 'arm64'
});
const WAD_DOWNLOAD_TIMEOUT_MS = 60000;
const POSSIBLE_WAD_INSTALL_ROOTS = [process.env['ProgramFiles(x86)'], process.env.ProgramFiles, `${process.env.SystemDrive || 'C:'}\\\\Program Files`];
const WAD_EXE_NAME = 'WinAppDriver.exe';
const UNINSTALL_REG_ROOT = 'HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall';
const REG_ENTRY_VALUE = 'Windows Application Driver';
const REG_ENTRY_KEY = 'DisplayName';
const REG_ENTRY_TYPE = 'REG_SZ';

const INST_LOCATION_SCRIPT_BY_GUID = guid => `
Set installer = CreateObject("WindowsInstaller.Installer")
Set session = installer.OpenProduct("${guid}")
session.DoAction("CostInitialize")
session.DoAction("CostFinalize")
WScript.Echo session.Property("INSTALLFOLDER")
`.replace(/\n/g, '\r\n');

function generateWadDownloadLink() {
  const wadArch = ARCH_MAPPING[process.arch];

  if (!wadArch) {
    throw new Error(`System architecture '${process.arch}' is not supported by Windows Application Driver. ` + `The only supported architectures are: ${_lodash.default.keys(ARCH_MAPPING)}`);
  }

  return `https://github.com/Microsoft/WinAppDriver` + `/releases/download/v${WAD_VER}/WindowsApplicationDriver-${WAD_VER}-win-${wadArch}.exe`;
}

async function fetchMsiInstallLocation(installerGuid) {
  const tmpRoot = await _appiumSupport.tempDir.openDir();

  const scriptPath = _path.default.join(tmpRoot, 'get_wad_inst_location.vbs');

  try {
    await _appiumSupport.fs.writeFile(scriptPath, INST_LOCATION_SCRIPT_BY_GUID(installerGuid), 'latin1');
    const {
      stdout
    } = await (0, _teen_process.exec)('cscript.exe', ['/Nologo', scriptPath]);
    return _lodash.default.trim(stdout);
  } finally {
    await _appiumSupport.fs.rimraf(tmpRoot);
  }
}

class WADNotFoundError extends _es6Error.default {}

const getWADExecutablePath = _lodash.default.memoize(async function getWADInstallPath() {
  const wadPath = process.env.APPIUM_WAD_PATH;

  if (await _appiumSupport.fs.exists(wadPath)) {
    _logger.default.debug(`Loaded WinAppDriver path from the APPIUM_WAD_PATH environment variable: ${wadPath}`);

    return wadPath;
  }

  const pathCandidates = POSSIBLE_WAD_INSTALL_ROOTS.filter(Boolean).map(root => _path.default.resolve(root, REG_ENTRY_VALUE, WAD_EXE_NAME));

  for (const result of pathCandidates) {
    if (await _appiumSupport.fs.exists(result)) {
      return result;
    }
  }

  _logger.default.debug('Did not detect WAD executable at any of the default install locations');

  _logger.default.debug('Checking the system registry for the corresponding MSI entry');

  try {
    const uninstallEntries = await (0, _registry.queryRegistry)(UNINSTALL_REG_ROOT);
    const wadEntry = uninstallEntries.find(({
      key,
      type,
      value
    }) => key === REG_ENTRY_KEY && value === REG_ENTRY_VALUE && type === REG_ENTRY_TYPE);

    if (wadEntry) {
      _logger.default.debug(`Found MSI entry: ${JSON.stringify(wadEntry)}`);

      const installerGuid = _lodash.default.last(wadEntry.root.split('\\'));

      const result = _path.default.join(await fetchMsiInstallLocation(installerGuid), WAD_EXE_NAME);

      _logger.default.debug(`Checking if WAD exists at '${result}'`);

      if (await _appiumSupport.fs.exists(result)) {
        return result;
      }

      _logger.default.debug(result);
    } else {
      _logger.default.debug('No WAD MSI entries have been found');
    }
  } catch (e) {
    if (e.stderr) {
      _logger.default.debug(e.stderr);
    }

    _logger.default.debug(e.stack);
  }

  throw new WADNotFoundError(`${WAD_EXE_NAME} has not been found in any of these ` + `locations: ${pathCandidates}. Is it installed?`);
});

exports.getWADExecutablePath = getWADExecutablePath;

async function downloadWAD() {
  const downloadLink = generateWadDownloadLink();

  const installerPath = _path.default.resolve(await _appiumSupport.tempDir.staticDir(), `wad_installer_${WAD_VER}_${_appiumSupport.util.uuidV4()}.exe`);

  _logger.default.info(`Downloading ${downloadLink} to '${installerPath}'`);

  await _appiumSupport.net.downloadFile(downloadLink, installerPath, {
    timeout: WAD_DOWNLOAD_TIMEOUT_MS
  });
  const downloadedMd5 = await _appiumSupport.fs.md5(installerPath);
  const expectedMd5 = WAD_DOWNLOAD_MD5[process.arch];

  if (downloadedMd5 !== expectedMd5) {
    await _appiumSupport.fs.rimraf(installerPath);
    throw new Error(`Installer executable checksum validation error: expected ${expectedMd5} but got ${downloadedMd5}`);
  }

  return installerPath;
}

const isAdmin = _lodash.default.memoize(async function isAdmin() {
  try {
    await (0, _teen_process.exec)('fsutil.exe', ['dirty', 'query', process.env.SystemDrive || 'C:']);
    return true;
  } catch (ign) {
    return false;
  }
});

exports.isAdmin = isAdmin;

async function setupWAD() {
  if (!_appiumSupport.system.isWindows()) {
    throw new Error(`Can only download WinAppDriver on Windows!`);
  }

  try {
    return await getWADExecutablePath();
  } catch (e) {
    if (!(e instanceof WADNotFoundError)) {
      throw e;
    }

    _logger.default.info(`WinAppDriver doesn't exist, setting up`);
  }

  if (!(await isAdmin())) {
    throw new Error(`You are not running as an administrator so WinAppDriver cannot be installed for you; please reinstall as admin`);
  }

  const installerPath = await downloadWAD();

  _logger.default.info('Running installer');

  try {
    await (0, _teen_process.exec)(installerPath, ['/install', '/quiet', '/norestart']);
  } finally {
    await _appiumSupport.fs.rimraf(installerPath);
  }
}

var _default = setupWAD;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9pbnN0YWxsZXIuanMiXSwibmFtZXMiOlsiV0FEX1ZFUiIsIldBRF9ET1dOTE9BRF9NRDUiLCJPYmplY3QiLCJmcmVlemUiLCJ4MzIiLCJ4NjQiLCJhcm02NCIsIkFSQ0hfTUFQUElORyIsIldBRF9ET1dOTE9BRF9USU1FT1VUX01TIiwiUE9TU0lCTEVfV0FEX0lOU1RBTExfUk9PVFMiLCJwcm9jZXNzIiwiZW52IiwiUHJvZ3JhbUZpbGVzIiwiU3lzdGVtRHJpdmUiLCJXQURfRVhFX05BTUUiLCJVTklOU1RBTExfUkVHX1JPT1QiLCJSRUdfRU5UUllfVkFMVUUiLCJSRUdfRU5UUllfS0VZIiwiUkVHX0VOVFJZX1RZUEUiLCJJTlNUX0xPQ0FUSU9OX1NDUklQVF9CWV9HVUlEIiwiZ3VpZCIsInJlcGxhY2UiLCJnZW5lcmF0ZVdhZERvd25sb2FkTGluayIsIndhZEFyY2giLCJhcmNoIiwiRXJyb3IiLCJfIiwia2V5cyIsImZldGNoTXNpSW5zdGFsbExvY2F0aW9uIiwiaW5zdGFsbGVyR3VpZCIsInRtcFJvb3QiLCJ0ZW1wRGlyIiwib3BlbkRpciIsInNjcmlwdFBhdGgiLCJwYXRoIiwiam9pbiIsImZzIiwid3JpdGVGaWxlIiwic3Rkb3V0IiwidHJpbSIsInJpbXJhZiIsIldBRE5vdEZvdW5kRXJyb3IiLCJFUzZFcnJvciIsImdldFdBREV4ZWN1dGFibGVQYXRoIiwibWVtb2l6ZSIsImdldFdBREluc3RhbGxQYXRoIiwid2FkUGF0aCIsIkFQUElVTV9XQURfUEFUSCIsImV4aXN0cyIsImxvZyIsImRlYnVnIiwicGF0aENhbmRpZGF0ZXMiLCJmaWx0ZXIiLCJCb29sZWFuIiwibWFwIiwicm9vdCIsInJlc29sdmUiLCJyZXN1bHQiLCJ1bmluc3RhbGxFbnRyaWVzIiwid2FkRW50cnkiLCJmaW5kIiwia2V5IiwidHlwZSIsInZhbHVlIiwiSlNPTiIsInN0cmluZ2lmeSIsImxhc3QiLCJzcGxpdCIsImUiLCJzdGRlcnIiLCJzdGFjayIsImRvd25sb2FkV0FEIiwiZG93bmxvYWRMaW5rIiwiaW5zdGFsbGVyUGF0aCIsInN0YXRpY0RpciIsInV0aWwiLCJ1dWlkVjQiLCJpbmZvIiwibmV0IiwiZG93bmxvYWRGaWxlIiwidGltZW91dCIsImRvd25sb2FkZWRNZDUiLCJtZDUiLCJleHBlY3RlZE1kNSIsImlzQWRtaW4iLCJpZ24iLCJzZXR1cFdBRCIsInN5c3RlbSIsImlzV2luZG93cyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQSxNQUFNQSxPQUFPLEdBQUcsUUFBaEI7QUFDQSxNQUFNQyxnQkFBZ0IsR0FBR0MsTUFBTSxDQUFDQyxNQUFQLENBQWM7QUFDckNDLEVBQUFBLEdBQUcsRUFBRSxrQ0FEZ0M7QUFFckNDLEVBQUFBLEdBQUcsRUFBRSxrQ0FGZ0M7QUFHckNDLEVBQUFBLEtBQUssRUFBRTtBQUg4QixDQUFkLENBQXpCO0FBS0EsTUFBTUMsWUFBWSxHQUFHTCxNQUFNLENBQUNDLE1BQVAsQ0FBYztBQUFDQyxFQUFBQSxHQUFHLEVBQUUsS0FBTjtBQUFhQyxFQUFBQSxHQUFHLEVBQUUsS0FBbEI7QUFBeUJDLEVBQUFBLEtBQUssRUFBRTtBQUFoQyxDQUFkLENBQXJCO0FBQ0EsTUFBTUUsdUJBQXVCLEdBQUcsS0FBaEM7QUFDQSxNQUFNQywwQkFBMEIsR0FBRyxDQUNqQ0MsT0FBTyxDQUFDQyxHQUFSLENBQVksbUJBQVosQ0FEaUMsRUFFakNELE9BQU8sQ0FBQ0MsR0FBUixDQUFZQyxZQUZxQixFQUdoQyxHQUFFRixPQUFPLENBQUNDLEdBQVIsQ0FBWUUsV0FBWixJQUEyQixJQUFLLG1CQUhGLENBQW5DO0FBS0EsTUFBTUMsWUFBWSxHQUFHLGtCQUFyQjtBQUNBLE1BQU1DLGtCQUFrQixHQUFHLCtEQUEzQjtBQUNBLE1BQU1DLGVBQWUsR0FBRyw0QkFBeEI7QUFDQSxNQUFNQyxhQUFhLEdBQUcsYUFBdEI7QUFDQSxNQUFNQyxjQUFjLEdBQUcsUUFBdkI7O0FBQ0EsTUFBTUMsNEJBQTRCLEdBQUlDLElBQUQsSUFBVztBQUNoRDtBQUNBLHVDQUF1Q0EsSUFBSztBQUM1QztBQUNBO0FBQ0E7QUFDQSxDQU4rQyxDQU03Q0MsT0FONkMsQ0FNckMsS0FOcUMsRUFNOUIsTUFOOEIsQ0FBL0M7O0FBU0EsU0FBU0MsdUJBQVQsR0FBb0M7QUFDbEMsUUFBTUMsT0FBTyxHQUFHaEIsWUFBWSxDQUFDRyxPQUFPLENBQUNjLElBQVQsQ0FBNUI7O0FBQ0EsTUFBSSxDQUFDRCxPQUFMLEVBQWM7QUFDWixVQUFNLElBQUlFLEtBQUosQ0FBVyx3QkFBdUJmLE9BQU8sQ0FBQ2MsSUFBSyxvREFBckMsR0FDYix5Q0FBd0NFLGdCQUFFQyxJQUFGLENBQU9wQixZQUFQLENBQXFCLEVBRDFELENBQU47QUFFRDs7QUFDRCxTQUFRLDJDQUFELEdBQ0osdUJBQXNCUCxPQUFRLDZCQUE0QkEsT0FBUSxRQUFPdUIsT0FBUSxNQURwRjtBQUVEOztBQUVELGVBQWVLLHVCQUFmLENBQXdDQyxhQUF4QyxFQUF1RDtBQUNyRCxRQUFNQyxPQUFPLEdBQUcsTUFBTUMsdUJBQVFDLE9BQVIsRUFBdEI7O0FBQ0EsUUFBTUMsVUFBVSxHQUFHQyxjQUFLQyxJQUFMLENBQVVMLE9BQVYsRUFBbUIsMkJBQW5CLENBQW5COztBQUNBLE1BQUk7QUFDRixVQUFNTSxrQkFBR0MsU0FBSCxDQUFhSixVQUFiLEVBQXlCZCw0QkFBNEIsQ0FBQ1UsYUFBRCxDQUFyRCxFQUFzRSxRQUF0RSxDQUFOO0FBQ0EsVUFBTTtBQUFDUyxNQUFBQTtBQUFELFFBQVcsTUFBTSx3QkFBSyxhQUFMLEVBQW9CLENBQUMsU0FBRCxFQUFZTCxVQUFaLENBQXBCLENBQXZCO0FBQ0EsV0FBT1AsZ0JBQUVhLElBQUYsQ0FBT0QsTUFBUCxDQUFQO0FBQ0QsR0FKRCxTQUlVO0FBQ1IsVUFBTUYsa0JBQUdJLE1BQUgsQ0FBVVYsT0FBVixDQUFOO0FBQ0Q7QUFDRjs7QUFFRCxNQUFNVyxnQkFBTixTQUErQkMsaUJBQS9CLENBQXdDOztBQUV4QyxNQUFNQyxvQkFBb0IsR0FBR2pCLGdCQUFFa0IsT0FBRixDQUFVLGVBQWVDLGlCQUFmLEdBQW9DO0FBQ3pFLFFBQU1DLE9BQU8sR0FBR3BDLE9BQU8sQ0FBQ0MsR0FBUixDQUFZb0MsZUFBNUI7O0FBQ0EsTUFBSSxNQUFNWCxrQkFBR1ksTUFBSCxDQUFVRixPQUFWLENBQVYsRUFBOEI7QUFDNUJHLG9CQUFJQyxLQUFKLENBQVcsMkVBQTBFSixPQUFRLEVBQTdGOztBQUNBLFdBQU9BLE9BQVA7QUFDRDs7QUFHRCxRQUFNSyxjQUFjLEdBQUcxQywwQkFBMEIsQ0FFOUMyQyxNQUZvQixDQUViQyxPQUZhLEVBSXBCQyxHQUpvQixDQUlmQyxJQUFELElBQVVyQixjQUFLc0IsT0FBTCxDQUFhRCxJQUFiLEVBQW1CdkMsZUFBbkIsRUFBb0NGLFlBQXBDLENBSk0sQ0FBdkI7O0FBS0EsT0FBSyxNQUFNMkMsTUFBWCxJQUFxQk4sY0FBckIsRUFBcUM7QUFDbkMsUUFBSSxNQUFNZixrQkFBR1ksTUFBSCxDQUFVUyxNQUFWLENBQVYsRUFBNkI7QUFDM0IsYUFBT0EsTUFBUDtBQUNEO0FBQ0Y7O0FBQ0RSLGtCQUFJQyxLQUFKLENBQVUsdUVBQVY7O0FBQ0FELGtCQUFJQyxLQUFKLENBQVUsOERBQVY7O0FBQ0EsTUFBSTtBQUNGLFVBQU1RLGdCQUFnQixHQUFHLE1BQU0sNkJBQWMzQyxrQkFBZCxDQUEvQjtBQUNBLFVBQU00QyxRQUFRLEdBQUdELGdCQUFnQixDQUFDRSxJQUFqQixDQUFzQixDQUFDO0FBQUNDLE1BQUFBLEdBQUQ7QUFBTUMsTUFBQUEsSUFBTjtBQUFZQyxNQUFBQTtBQUFaLEtBQUQsS0FDckNGLEdBQUcsS0FBSzVDLGFBQVIsSUFBeUI4QyxLQUFLLEtBQUsvQyxlQUFuQyxJQUFzRDhDLElBQUksS0FBSzVDLGNBRGhELENBQWpCOztBQUdBLFFBQUl5QyxRQUFKLEVBQWM7QUFDWlYsc0JBQUlDLEtBQUosQ0FBVyxvQkFBbUJjLElBQUksQ0FBQ0MsU0FBTCxDQUFlTixRQUFmLENBQXlCLEVBQXZEOztBQUNBLFlBQU05QixhQUFhLEdBQUdILGdCQUFFd0MsSUFBRixDQUFPUCxRQUFRLENBQUNKLElBQVQsQ0FBY1ksS0FBZCxDQUFvQixJQUFwQixDQUFQLENBQXRCOztBQUdBLFlBQU1WLE1BQU0sR0FBR3ZCLGNBQUtDLElBQUwsQ0FBVSxNQUFNUCx1QkFBdUIsQ0FBQ0MsYUFBRCxDQUF2QyxFQUF3RGYsWUFBeEQsQ0FBZjs7QUFDQW1DLHNCQUFJQyxLQUFKLENBQVcsOEJBQTZCTyxNQUFPLEdBQS9DOztBQUNBLFVBQUksTUFBTXJCLGtCQUFHWSxNQUFILENBQVVTLE1BQVYsQ0FBVixFQUE2QjtBQUMzQixlQUFPQSxNQUFQO0FBQ0Q7O0FBQ0RSLHNCQUFJQyxLQUFKLENBQVVPLE1BQVY7QUFDRCxLQVhELE1BV087QUFDTFIsc0JBQUlDLEtBQUosQ0FBVSxvQ0FBVjtBQUNEO0FBQ0YsR0FuQkQsQ0FtQkUsT0FBT2tCLENBQVAsRUFBVTtBQUNWLFFBQUlBLENBQUMsQ0FBQ0MsTUFBTixFQUFjO0FBQ1pwQixzQkFBSUMsS0FBSixDQUFVa0IsQ0FBQyxDQUFDQyxNQUFaO0FBQ0Q7O0FBQ0RwQixvQkFBSUMsS0FBSixDQUFVa0IsQ0FBQyxDQUFDRSxLQUFaO0FBQ0Q7O0FBQ0QsUUFBTSxJQUFJN0IsZ0JBQUosQ0FBc0IsR0FBRTNCLFlBQWEsc0NBQWhCLEdBQ3hCLGNBQWFxQyxjQUFlLG9CQUR6QixDQUFOO0FBRUQsQ0EvQzRCLENBQTdCOzs7O0FBaURBLGVBQWVvQixXQUFmLEdBQThCO0FBQzVCLFFBQU1DLFlBQVksR0FBR2xELHVCQUF1QixFQUE1Qzs7QUFDQSxRQUFNbUQsYUFBYSxHQUFHdkMsY0FBS3NCLE9BQUwsQ0FBYSxNQUFNekIsdUJBQVEyQyxTQUFSLEVBQW5CLEVBQ25CLGlCQUFnQjFFLE9BQVEsSUFBRzJFLG9CQUFLQyxNQUFMLEVBQWMsTUFEdEIsQ0FBdEI7O0FBRUEzQixrQkFBSTRCLElBQUosQ0FBVSxlQUFjTCxZQUFhLFFBQU9DLGFBQWMsR0FBMUQ7O0FBQ0EsUUFBTUssbUJBQUlDLFlBQUosQ0FBaUJQLFlBQWpCLEVBQStCQyxhQUEvQixFQUE4QztBQUFDTyxJQUFBQSxPQUFPLEVBQUV4RTtBQUFWLEdBQTlDLENBQU47QUFDQSxRQUFNeUUsYUFBYSxHQUFHLE1BQU03QyxrQkFBRzhDLEdBQUgsQ0FBT1QsYUFBUCxDQUE1QjtBQUNBLFFBQU1VLFdBQVcsR0FBR2xGLGdCQUFnQixDQUFDUyxPQUFPLENBQUNjLElBQVQsQ0FBcEM7O0FBQ0EsTUFBSXlELGFBQWEsS0FBS0UsV0FBdEIsRUFBbUM7QUFDakMsVUFBTS9DLGtCQUFHSSxNQUFILENBQVVpQyxhQUFWLENBQU47QUFDQSxVQUFNLElBQUloRCxLQUFKLENBQ0gsNERBQTJEMEQsV0FBWSxZQUFXRixhQUFjLEVBRDdGLENBQU47QUFHRDs7QUFDRCxTQUFPUixhQUFQO0FBQ0Q7O0FBRUQsTUFBTVcsT0FBTyxHQUFHMUQsZ0JBQUVrQixPQUFGLENBQVUsZUFBZXdDLE9BQWYsR0FBMEI7QUFDbEQsTUFBSTtBQUNGLFVBQU0sd0JBQUssWUFBTCxFQUFtQixDQUFDLE9BQUQsRUFBVSxPQUFWLEVBQW1CMUUsT0FBTyxDQUFDQyxHQUFSLENBQVlFLFdBQVosSUFBMkIsSUFBOUMsQ0FBbkIsQ0FBTjtBQUNBLFdBQU8sSUFBUDtBQUNELEdBSEQsQ0FHRSxPQUFPd0UsR0FBUCxFQUFZO0FBQ1osV0FBTyxLQUFQO0FBQ0Q7QUFDRixDQVBlLENBQWhCOzs7O0FBU0EsZUFBZUMsUUFBZixHQUEyQjtBQUN6QixNQUFJLENBQUNDLHNCQUFPQyxTQUFQLEVBQUwsRUFBeUI7QUFDdkIsVUFBTSxJQUFJL0QsS0FBSixDQUFXLDRDQUFYLENBQU47QUFDRDs7QUFFRCxNQUFJO0FBQ0YsV0FBTyxNQUFNa0Isb0JBQW9CLEVBQWpDO0FBQ0QsR0FGRCxDQUVFLE9BQU95QixDQUFQLEVBQVU7QUFDVixRQUFJLEVBQUVBLENBQUMsWUFBWTNCLGdCQUFmLENBQUosRUFBc0M7QUFDcEMsWUFBTTJCLENBQU47QUFDRDs7QUFDRG5CLG9CQUFJNEIsSUFBSixDQUFVLHdDQUFWO0FBQ0Q7O0FBRUQsTUFBSSxFQUFDLE1BQU1PLE9BQU8sRUFBZCxDQUFKLEVBQXNCO0FBQ3BCLFVBQU0sSUFBSTNELEtBQUosQ0FBVyxnSEFBWCxDQUFOO0FBQ0Q7O0FBRUQsUUFBTWdELGFBQWEsR0FBRyxNQUFNRixXQUFXLEVBQXZDOztBQUNBdEIsa0JBQUk0QixJQUFKLENBQVMsbUJBQVQ7O0FBQ0EsTUFBSTtBQUNGLFVBQU0sd0JBQUtKLGFBQUwsRUFBb0IsQ0FBQyxVQUFELEVBQWEsUUFBYixFQUF1QixZQUF2QixDQUFwQixDQUFOO0FBQ0QsR0FGRCxTQUVVO0FBQ1IsVUFBTXJDLGtCQUFHSSxNQUFILENBQVVpQyxhQUFWLENBQU47QUFDRDtBQUNGOztlQUdjYSxRIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IHN5c3RlbSwgZnMsIHV0aWwsIG5ldCwgdGVtcERpciB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCBFUzZFcnJvciBmcm9tICdlczYtZXJyb3InO1xuaW1wb3J0IHsgcXVlcnlSZWdpc3RyeSB9IGZyb20gJy4vcmVnaXN0cnknO1xuXG4vLyBodHRwczovL2dpdGh1Yi5jb20vbWljcm9zb2Z0L1dpbkFwcERyaXZlci9yZWxlYXNlc1xuY29uc3QgV0FEX1ZFUiA9ICcxLjIuOTknO1xuY29uc3QgV0FEX0RPV05MT0FEX01ENSA9IE9iamVjdC5mcmVlemUoe1xuICB4MzI6ICcyMzc0NWU2ZWQzNzNiYzk2OWZmN2M0NDkzZTMyNzU2YScsXG4gIHg2NDogJzI5MjNmYzUzOWYzODlkNDc3NTRhNzUyMWVlNTAxMDhlJyxcbiAgYXJtNjQ6ICdiOWFmNDIyMmEzZmIwZDY4OGVjZmJmNjA1ZDFjNDUwMCcsXG59KTtcbmNvbnN0IEFSQ0hfTUFQUElORyA9IE9iamVjdC5mcmVlemUoe3gzMjogJ3g4NicsIHg2NDogJ3g2NCcsIGFybTY0OiAnYXJtNjQnfSk7XG5jb25zdCBXQURfRE9XTkxPQURfVElNRU9VVF9NUyA9IDYwMDAwO1xuY29uc3QgUE9TU0lCTEVfV0FEX0lOU1RBTExfUk9PVFMgPSBbXG4gIHByb2Nlc3MuZW52WydQcm9ncmFtRmlsZXMoeDg2KSddLFxuICBwcm9jZXNzLmVudi5Qcm9ncmFtRmlsZXMsXG4gIGAke3Byb2Nlc3MuZW52LlN5c3RlbURyaXZlIHx8ICdDOid9XFxcXFxcXFxQcm9ncmFtIEZpbGVzYCxcbl07XG5jb25zdCBXQURfRVhFX05BTUUgPSAnV2luQXBwRHJpdmVyLmV4ZSc7XG5jb25zdCBVTklOU1RBTExfUkVHX1JPT1QgPSAnSEtMTVxcXFxTb2Z0d2FyZVxcXFxNaWNyb3NvZnRcXFxcV2luZG93c1xcXFxDdXJyZW50VmVyc2lvblxcXFxVbmluc3RhbGwnO1xuY29uc3QgUkVHX0VOVFJZX1ZBTFVFID0gJ1dpbmRvd3MgQXBwbGljYXRpb24gRHJpdmVyJztcbmNvbnN0IFJFR19FTlRSWV9LRVkgPSAnRGlzcGxheU5hbWUnO1xuY29uc3QgUkVHX0VOVFJZX1RZUEUgPSAnUkVHX1NaJztcbmNvbnN0IElOU1RfTE9DQVRJT05fU0NSSVBUX0JZX0dVSUQgPSAoZ3VpZCkgPT4gYFxuU2V0IGluc3RhbGxlciA9IENyZWF0ZU9iamVjdChcIldpbmRvd3NJbnN0YWxsZXIuSW5zdGFsbGVyXCIpXG5TZXQgc2Vzc2lvbiA9IGluc3RhbGxlci5PcGVuUHJvZHVjdChcIiR7Z3VpZH1cIilcbnNlc3Npb24uRG9BY3Rpb24oXCJDb3N0SW5pdGlhbGl6ZVwiKVxuc2Vzc2lvbi5Eb0FjdGlvbihcIkNvc3RGaW5hbGl6ZVwiKVxuV1NjcmlwdC5FY2hvIHNlc3Npb24uUHJvcGVydHkoXCJJTlNUQUxMRk9MREVSXCIpXG5gLnJlcGxhY2UoL1xcbi9nLCAnXFxyXFxuJyk7XG5cblxuZnVuY3Rpb24gZ2VuZXJhdGVXYWREb3dubG9hZExpbmsgKCkge1xuICBjb25zdCB3YWRBcmNoID0gQVJDSF9NQVBQSU5HW3Byb2Nlc3MuYXJjaF07XG4gIGlmICghd2FkQXJjaCkge1xuICAgIHRocm93IG5ldyBFcnJvcihgU3lzdGVtIGFyY2hpdGVjdHVyZSAnJHtwcm9jZXNzLmFyY2h9JyBpcyBub3Qgc3VwcG9ydGVkIGJ5IFdpbmRvd3MgQXBwbGljYXRpb24gRHJpdmVyLiBgICtcbiAgICAgIGBUaGUgb25seSBzdXBwb3J0ZWQgYXJjaGl0ZWN0dXJlcyBhcmU6ICR7Xy5rZXlzKEFSQ0hfTUFQUElORyl9YCk7XG4gIH1cbiAgcmV0dXJuIGBodHRwczovL2dpdGh1Yi5jb20vTWljcm9zb2Z0L1dpbkFwcERyaXZlcmAgK1xuICAgIGAvcmVsZWFzZXMvZG93bmxvYWQvdiR7V0FEX1ZFUn0vV2luZG93c0FwcGxpY2F0aW9uRHJpdmVyLSR7V0FEX1ZFUn0td2luLSR7d2FkQXJjaH0uZXhlYDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZmV0Y2hNc2lJbnN0YWxsTG9jYXRpb24gKGluc3RhbGxlckd1aWQpIHtcbiAgY29uc3QgdG1wUm9vdCA9IGF3YWl0IHRlbXBEaXIub3BlbkRpcigpO1xuICBjb25zdCBzY3JpcHRQYXRoID0gcGF0aC5qb2luKHRtcFJvb3QsICdnZXRfd2FkX2luc3RfbG9jYXRpb24udmJzJyk7XG4gIHRyeSB7XG4gICAgYXdhaXQgZnMud3JpdGVGaWxlKHNjcmlwdFBhdGgsIElOU1RfTE9DQVRJT05fU0NSSVBUX0JZX0dVSUQoaW5zdGFsbGVyR3VpZCksICdsYXRpbjEnKTtcbiAgICBjb25zdCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWMoJ2NzY3JpcHQuZXhlJywgWycvTm9sb2dvJywgc2NyaXB0UGF0aF0pO1xuICAgIHJldHVybiBfLnRyaW0oc3Rkb3V0KTtcbiAgfSBmaW5hbGx5IHtcbiAgICBhd2FpdCBmcy5yaW1yYWYodG1wUm9vdCk7XG4gIH1cbn1cblxuY2xhc3MgV0FETm90Rm91bmRFcnJvciBleHRlbmRzIEVTNkVycm9yIHt9XG5cbmNvbnN0IGdldFdBREV4ZWN1dGFibGVQYXRoID0gXy5tZW1vaXplKGFzeW5jIGZ1bmN0aW9uIGdldFdBREluc3RhbGxQYXRoICgpIHtcbiAgY29uc3Qgd2FkUGF0aCA9IHByb2Nlc3MuZW52LkFQUElVTV9XQURfUEFUSDtcbiAgaWYgKGF3YWl0IGZzLmV4aXN0cyh3YWRQYXRoKSkge1xuICAgIGxvZy5kZWJ1ZyhgTG9hZGVkIFdpbkFwcERyaXZlciBwYXRoIGZyb20gdGhlIEFQUElVTV9XQURfUEFUSCBlbnZpcm9ubWVudCB2YXJpYWJsZTogJHt3YWRQYXRofWApO1xuICAgIHJldHVybiB3YWRQYXRoO1xuICB9XG5cbiAgLy8gVE9ETzogV0FEIGluc3RhbGxlciBzaG91bGQgd3JpdGUgdGhlIGZ1bGwgcGF0aCB0byBpdCBpbnRvIHRoZSBzeXN0ZW0gcmVnaXN0cnlcbiAgY29uc3QgcGF0aENhbmRpZGF0ZXMgPSBQT1NTSUJMRV9XQURfSU5TVEFMTF9ST09UU1xuICAgIC8vIHJlbW92ZSB1bnNldCBlbnYgdmFyaWFibGVzXG4gICAgLmZpbHRlcihCb29sZWFuKVxuICAgIC8vIGNvbnN0cnVjdCBmdWxsIHBhdGhcbiAgICAubWFwKChyb290KSA9PiBwYXRoLnJlc29sdmUocm9vdCwgUkVHX0VOVFJZX1ZBTFVFLCBXQURfRVhFX05BTUUpKTtcbiAgZm9yIChjb25zdCByZXN1bHQgb2YgcGF0aENhbmRpZGF0ZXMpIHtcbiAgICBpZiAoYXdhaXQgZnMuZXhpc3RzKHJlc3VsdCkpIHtcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuICB9XG4gIGxvZy5kZWJ1ZygnRGlkIG5vdCBkZXRlY3QgV0FEIGV4ZWN1dGFibGUgYXQgYW55IG9mIHRoZSBkZWZhdWx0IGluc3RhbGwgbG9jYXRpb25zJyk7XG4gIGxvZy5kZWJ1ZygnQ2hlY2tpbmcgdGhlIHN5c3RlbSByZWdpc3RyeSBmb3IgdGhlIGNvcnJlc3BvbmRpbmcgTVNJIGVudHJ5Jyk7XG4gIHRyeSB7XG4gICAgY29uc3QgdW5pbnN0YWxsRW50cmllcyA9IGF3YWl0IHF1ZXJ5UmVnaXN0cnkoVU5JTlNUQUxMX1JFR19ST09UKTtcbiAgICBjb25zdCB3YWRFbnRyeSA9IHVuaW5zdGFsbEVudHJpZXMuZmluZCgoe2tleSwgdHlwZSwgdmFsdWV9KSA9PlxuICAgICAga2V5ID09PSBSRUdfRU5UUllfS0VZICYmIHZhbHVlID09PSBSRUdfRU5UUllfVkFMVUUgJiYgdHlwZSA9PT0gUkVHX0VOVFJZX1RZUEVcbiAgICApO1xuICAgIGlmICh3YWRFbnRyeSkge1xuICAgICAgbG9nLmRlYnVnKGBGb3VuZCBNU0kgZW50cnk6ICR7SlNPTi5zdHJpbmdpZnkod2FkRW50cnkpfWApO1xuICAgICAgY29uc3QgaW5zdGFsbGVyR3VpZCA9IF8ubGFzdCh3YWRFbnRyeS5yb290LnNwbGl0KCdcXFxcJykpO1xuICAgICAgLy8gV0FEIE1TSSBpbnN0YWxsZXIgbGVhdmVzIEluc3RhbGxMb2NhdGlvbiByZWdpc3RyeSB2YWx1ZSBlbXB0eSxcbiAgICAgIC8vIHNvIHdlIG5lZWQgdG8gYmUgaGFja3kgaGVyZVxuICAgICAgY29uc3QgcmVzdWx0ID0gcGF0aC5qb2luKGF3YWl0IGZldGNoTXNpSW5zdGFsbExvY2F0aW9uKGluc3RhbGxlckd1aWQpLCBXQURfRVhFX05BTUUpO1xuICAgICAgbG9nLmRlYnVnKGBDaGVja2luZyBpZiBXQUQgZXhpc3RzIGF0ICcke3Jlc3VsdH0nYCk7XG4gICAgICBpZiAoYXdhaXQgZnMuZXhpc3RzKHJlc3VsdCkpIHtcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgIH1cbiAgICAgIGxvZy5kZWJ1ZyhyZXN1bHQpO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2cuZGVidWcoJ05vIFdBRCBNU0kgZW50cmllcyBoYXZlIGJlZW4gZm91bmQnKTtcbiAgICB9XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBpZiAoZS5zdGRlcnIpIHtcbiAgICAgIGxvZy5kZWJ1ZyhlLnN0ZGVycik7XG4gICAgfVxuICAgIGxvZy5kZWJ1ZyhlLnN0YWNrKTtcbiAgfVxuICB0aHJvdyBuZXcgV0FETm90Rm91bmRFcnJvcihgJHtXQURfRVhFX05BTUV9IGhhcyBub3QgYmVlbiBmb3VuZCBpbiBhbnkgb2YgdGhlc2UgYCArXG4gICAgYGxvY2F0aW9uczogJHtwYXRoQ2FuZGlkYXRlc30uIElzIGl0IGluc3RhbGxlZD9gKTtcbn0pO1xuXG5hc3luYyBmdW5jdGlvbiBkb3dubG9hZFdBRCAoKSB7XG4gIGNvbnN0IGRvd25sb2FkTGluayA9IGdlbmVyYXRlV2FkRG93bmxvYWRMaW5rKCk7XG4gIGNvbnN0IGluc3RhbGxlclBhdGggPSBwYXRoLnJlc29sdmUoYXdhaXQgdGVtcERpci5zdGF0aWNEaXIoKSxcbiAgICBgd2FkX2luc3RhbGxlcl8ke1dBRF9WRVJ9XyR7dXRpbC51dWlkVjQoKX0uZXhlYCk7XG4gIGxvZy5pbmZvKGBEb3dubG9hZGluZyAke2Rvd25sb2FkTGlua30gdG8gJyR7aW5zdGFsbGVyUGF0aH0nYCk7XG4gIGF3YWl0IG5ldC5kb3dubG9hZEZpbGUoZG93bmxvYWRMaW5rLCBpbnN0YWxsZXJQYXRoLCB7dGltZW91dDogV0FEX0RPV05MT0FEX1RJTUVPVVRfTVN9KTtcbiAgY29uc3QgZG93bmxvYWRlZE1kNSA9IGF3YWl0IGZzLm1kNShpbnN0YWxsZXJQYXRoKTtcbiAgY29uc3QgZXhwZWN0ZWRNZDUgPSBXQURfRE9XTkxPQURfTUQ1W3Byb2Nlc3MuYXJjaF07XG4gIGlmIChkb3dubG9hZGVkTWQ1ICE9PSBleHBlY3RlZE1kNSkge1xuICAgIGF3YWl0IGZzLnJpbXJhZihpbnN0YWxsZXJQYXRoKTtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBgSW5zdGFsbGVyIGV4ZWN1dGFibGUgY2hlY2tzdW0gdmFsaWRhdGlvbiBlcnJvcjogZXhwZWN0ZWQgJHtleHBlY3RlZE1kNX0gYnV0IGdvdCAke2Rvd25sb2FkZWRNZDV9YFxuICAgICk7XG4gIH1cbiAgcmV0dXJuIGluc3RhbGxlclBhdGg7XG59XG5cbmNvbnN0IGlzQWRtaW4gPSBfLm1lbW9pemUoYXN5bmMgZnVuY3Rpb24gaXNBZG1pbiAoKSB7XG4gIHRyeSB7XG4gICAgYXdhaXQgZXhlYygnZnN1dGlsLmV4ZScsIFsnZGlydHknLCAncXVlcnknLCBwcm9jZXNzLmVudi5TeXN0ZW1Ecml2ZSB8fCAnQzonXSk7XG4gICAgcmV0dXJuIHRydWU7XG4gIH0gY2F0Y2ggKGlnbikge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxufSk7XG5cbmFzeW5jIGZ1bmN0aW9uIHNldHVwV0FEICgpIHtcbiAgaWYgKCFzeXN0ZW0uaXNXaW5kb3dzKCkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYENhbiBvbmx5IGRvd25sb2FkIFdpbkFwcERyaXZlciBvbiBXaW5kb3dzIWApO1xuICB9XG5cbiAgdHJ5IHtcbiAgICByZXR1cm4gYXdhaXQgZ2V0V0FERXhlY3V0YWJsZVBhdGgoKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGlmICghKGUgaW5zdGFuY2VvZiBXQUROb3RGb3VuZEVycm9yKSkge1xuICAgICAgdGhyb3cgZTtcbiAgICB9XG4gICAgbG9nLmluZm8oYFdpbkFwcERyaXZlciBkb2Vzbid0IGV4aXN0LCBzZXR0aW5nIHVwYCk7XG4gIH1cblxuICBpZiAoIWF3YWl0IGlzQWRtaW4oKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgWW91IGFyZSBub3QgcnVubmluZyBhcyBhbiBhZG1pbmlzdHJhdG9yIHNvIFdpbkFwcERyaXZlciBjYW5ub3QgYmUgaW5zdGFsbGVkIGZvciB5b3U7IHBsZWFzZSByZWluc3RhbGwgYXMgYWRtaW5gKTtcbiAgfVxuXG4gIGNvbnN0IGluc3RhbGxlclBhdGggPSBhd2FpdCBkb3dubG9hZFdBRCgpO1xuICBsb2cuaW5mbygnUnVubmluZyBpbnN0YWxsZXInKTtcbiAgdHJ5IHtcbiAgICBhd2FpdCBleGVjKGluc3RhbGxlclBhdGgsIFsnL2luc3RhbGwnLCAnL3F1aWV0JywgJy9ub3Jlc3RhcnQnXSk7XG4gIH0gZmluYWxseSB7XG4gICAgYXdhaXQgZnMucmltcmFmKGluc3RhbGxlclBhdGgpO1xuICB9XG59XG5cbmV4cG9ydCB7IGRvd25sb2FkV0FELCBzZXR1cFdBRCwgZ2V0V0FERXhlY3V0YWJsZVBhdGgsIGlzQWRtaW4gfTtcbmV4cG9ydCBkZWZhdWx0IHNldHVwV0FEO1xuIl0sImZpbGUiOiJsaWIvaW5zdGFsbGVyLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
